# TASK 8: ç”¨æˆ¶ç®¡ç†ç³»çµ±

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

å»ºç«‹å®Œæ•´çš„ç”¨æˆ¶ç®¡ç†ç³»çµ±ï¼ŒåŒ…å«ç”¨æˆ¶è¨»å†Šã€å€‹äººè³‡æ–™ç®¡ç†ã€è§’è‰²æ¬Šé™ç­‰åŠŸèƒ½ã€‚

### ğŸ¯ ç›®æ¨™
- å¯¦ç¾ç”¨æˆ¶è¨»å†Šå’Œå€‹äººè³‡æ–™ç®¡ç†
- å»ºç«‹è§’è‰²å’Œæ¬Šé™ç³»çµ±
- æä¾›ç”¨æˆ¶æŸ¥è©¢å’Œç®¡ç†åŠŸèƒ½
- æ•´åˆéƒµä»¶é©—è­‰æ©Ÿåˆ¶

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… JWT èªè­‰ç³»çµ±å·²å¯¦ç¾ (TASK 7)
- âœ… åŸºç¤è³‡æ–™åº« schema å·²å»ºç«‹
- âœ… ä¸­é–“ä»¶ç³»çµ±å·²å®Œæˆ

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ”§ æ–°å¢ä¾è³´å¥—ä»¶
```bash
npm install nodemailer validator
npm install --save-dev @types/nodemailer @types/validator
```

### ğŸ—„ï¸ è³‡æ–™åº« Schema æ“´å±•

```typescript
// packages/db/src/schemas/users.ts
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: text('email').notNull().unique(),
  username: text('username').notNull().unique(),
  passwordHash: text('password_hash').notNull(),
  firstName: text('first_name'),
  lastName: text('last_name'),
  avatar: text('avatar_url'),
  bio: text('bio'),
  role: text('role').default('user').notNull(), // user, moderator, admin
  status: text('status').default('pending').notNull(), // pending, active, suspended, deleted
  emailVerified: boolean('email_verified').default(false).notNull(),
  emailVerificationToken: text('email_verification_token'),
  passwordResetToken: text('password_reset_token'),
  passwordResetExpiry: timestamp('password_reset_expiry'),
  lastLoginAt: timestamp('last_login_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const userSessions = pgTable('user_sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id).notNull(),
  deviceInfo: text('device_info'),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  isActive: boolean('is_active').default(true).notNull(),
  lastActivityAt: timestamp('last_activity_at').defaultNow().notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

---

## ğŸ“ æª”æ¡ˆçµæ§‹

### æ–°å¢/æ›´æ–°æª”æ¡ˆ
```
apps/server/src/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ controller.ts      # ç”¨æˆ¶ç®¡ç† Controller
â”‚   â”œâ”€â”€ service.ts         # ç”¨æˆ¶ç®¡ç† Service  
â”‚   â”œâ”€â”€ types.ts           # ç”¨æˆ¶ç›¸é—œå‹åˆ¥å®šç¾©
â”‚   â””â”€â”€ routes.ts          # ç”¨æˆ¶ç®¡ç†è·¯ç”±
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ controller.ts      # æ›´æ–°èªè­‰ Controller
â”‚   â”œâ”€â”€ service.ts         # æ›´æ–°èªè­‰ Service
â”‚   â””â”€â”€ email.ts           # éƒµä»¶æœå‹™
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ role.ts            # è§’è‰²æ¬Šé™ä¸­é–“ä»¶
â””â”€â”€ test/
    â””â”€â”€ users/
        â”œâ”€â”€ controller.test.ts
        â”œâ”€â”€ service.test.ts
        â””â”€â”€ integration.test.ts
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: ç”¨æˆ¶è³‡æ–™æ¨¡å‹å’Œå‹åˆ¥
å®šç¾©å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™çµæ§‹ï¼š

```typescript
// apps/server/src/users/types.ts
export interface User {
  id: string;
  email: string;
  username: string;
  firstName?: string;
  lastName?: string;
  avatar?: string;
  bio?: string;
  role: UserRole;
  status: UserStatus;
  emailVerified: boolean;
  lastLoginAt?: Date;
  createdAt: Date;
  updatedAt: Date;
}

export enum UserRole {
  USER = 'user',
  MODERATOR = 'moderator', 
  ADMIN = 'admin'
}

export enum UserStatus {
  PENDING = 'pending',
  ACTIVE = 'active',
  SUSPENDED = 'suspended',
  DELETED = 'deleted'
}

export const updateUserProfileSchema = z.object({
  firstName: z.string().min(1).max(50).optional(),
  lastName: z.string().min(1).max(50).optional(),
  bio: z.string().max(500).optional(),
  avatar: z.string().url().optional(),
});
```

### Step 2: ç”¨æˆ¶ç®¡ç† Service
å¯¦ç¾æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼š

```typescript
// apps/server/src/users/service.ts
export class UserService {
  async getUserById(id: string): Promise<User | null>
  async getUserByEmail(email: string): Promise<User | null>
  async getUserByUsername(username: string): Promise<User | null>
  async updateUserProfile(id: string, data: UpdateUserProfileRequest): Promise<User>
  async changePassword(id: string, oldPassword: string, newPassword: string): Promise<boolean>
  async deleteUser(id: string): Promise<boolean>
  async getAllUsers(query: GetUsersQuery): Promise<GetUsersResult>
  async updateUserRole(id: string, role: UserRole): Promise<User>
  async updateUserStatus(id: string, status: UserStatus): Promise<User>
  async searchUsers(query: string): Promise<User[]>
}
```

### Step 3: éƒµä»¶é©—è­‰æœå‹™
å¯¦ç¾éƒµä»¶åŠŸèƒ½ï¼š

```typescript
// apps/server/src/auth/email.ts
export class EmailService {
  async sendVerificationEmail(user: User): Promise<boolean>
  async sendPasswordResetEmail(user: User): Promise<boolean>
  async sendWelcomeEmail(user: User): Promise<boolean>
  async verifyEmail(token: string): Promise<boolean>
  async requestPasswordReset(email: string): Promise<boolean>
  async resetPassword(token: string, newPassword: string): Promise<boolean>
}
```

### Step 4: è§’è‰²æ¬Šé™ä¸­é–“ä»¶
å¯¦ç¾åŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶ï¼š

```typescript
// apps/server/src/middleware/role.ts
export const requireRole = (roles: UserRole[]) => {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    // 1. ç¢ºèªç”¨æˆ¶å·²èªè­‰
    // 2. æª¢æŸ¥ç”¨æˆ¶è§’è‰²
    // 3. é©—è­‰æ¬Šé™
    // 4. è™•ç†æœªæˆæ¬Šæƒ…æ³
  }
}

export const requireAdmin = requireRole([UserRole.ADMIN]);
export const requireModerator = requireRole([UserRole.MODERATOR, UserRole.ADMIN]);
```

### Step 5: ç”¨æˆ¶ç®¡ç† Controller
è™•ç† HTTP è«‹æ±‚ï¼š

```typescript
// apps/server/src/users/controller.ts
export class UserController {
  async getProfile(request: FastifyRequest, reply: FastifyReply)
  async updateProfile(request: FastifyRequest, reply: FastifyReply)
  async changePassword(request: FastifyRequest, reply: FastifyReply)
  async deleteAccount(request: FastifyRequest, reply: FastifyReply)
  
  // Admin åŠŸèƒ½
  async getAllUsers(request: FastifyRequest, reply: FastifyReply)
  async getUserById(request: FastifyRequest, reply: FastifyReply)
  async updateUserRole(request: FastifyRequest, reply: FastifyReply)
  async updateUserStatus(request: FastifyRequest, reply: FastifyReply)
  async searchUsers(request: FastifyRequest, reply: FastifyReply)
}
```

### Step 6: æ“´å±•èªè­‰åŠŸèƒ½
æ›´æ–°è¨»å†Šæµç¨‹ä»¥æ”¯æ´éƒµä»¶é©—è­‰ï¼š

```typescript
// æ›´æ–° apps/server/src/auth/service.ts
export class AuthService {
  async register(userData: RegisterRequest): Promise<RegisterResult> {
    // 1. é©—è­‰è³‡æ–™
    // 2. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²å­˜åœ¨
    // 3. é›œæ¹Šå¯†ç¢¼
    // 4. å‰µå»ºç”¨æˆ¶
    // 5. ç™¼é€é©—è­‰éƒµä»¶
    // 6. å›å‚³çµæœ
  }
  
  async verifyEmail(token: string): Promise<boolean>
  async resendVerification(email: string): Promise<boolean>
}
```

---

## ğŸ“‹ API ç«¯é»è¨­è¨ˆ

### ç”¨æˆ¶å€‹äººè³‡æ–™ç®¡ç†

#### GET /users/profile
å–å¾—ç•¶å‰ç”¨æˆ¶è³‡æ–™
- éœ€è¦èªè­‰

#### PUT /users/profile
æ›´æ–°å€‹äººè³‡æ–™
```json
{
  "firstName": "John",
  "lastName": "Doe", 
  "bio": "Software Developer",
  "avatar": "https://example.com/avatar.jpg"
}
```

#### POST /users/change-password
ä¿®æ”¹å¯†ç¢¼
```json
{
  "oldPassword": "current_password",
  "newPassword": "new_password"
}
```

### éƒµä»¶é©—è­‰

#### POST /auth/verify-email
```json
{
  "token": "verification_token"
}
```

#### POST /auth/resend-verification
```json
{
  "email": "user@example.com"
}
```

#### POST /auth/forgot-password
```json
{
  "email": "user@example.com"
}
```

#### POST /auth/reset-password
```json
{
  "token": "reset_token",
  "newPassword": "new_password"
}
```

### ç®¡ç†å“¡åŠŸèƒ½ (éœ€è¦ç›¸æ‡‰æ¬Šé™)

#### GET /admin/users
å–å¾—æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨
- æ”¯æ´åˆ†é å’Œç¯©é¸
- éœ€è¦ moderator æˆ– admin æ¬Šé™

#### GET /admin/users/:id
å–å¾—æŒ‡å®šç”¨æˆ¶è©³ç´°è³‡æ–™
- éœ€è¦ moderator æˆ– admin æ¬Šé™

#### PUT /admin/users/:id/role
æ›´æ–°ç”¨æˆ¶è§’è‰²
```json
{
  "role": "moderator"
}
```

#### PUT /admin/users/:id/status
æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
```json
{
  "status": "suspended"
}
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### Unit Tests
- UserService æ¥­å‹™é‚è¼¯æ¸¬è©¦
- EmailService éƒµä»¶åŠŸèƒ½æ¸¬è©¦
- UserController HTTP è™•ç†æ¸¬è©¦
- è§’è‰²æ¬Šé™ä¸­é–“ä»¶æ¸¬è©¦

### Integration Tests
- å®Œæ•´ç”¨æˆ¶è¨»å†Šæµç¨‹æ¸¬è©¦
- éƒµä»¶é©—è­‰æµç¨‹æ¸¬è©¦
- å¯†ç¢¼é‡è¨­æµç¨‹æ¸¬è©¦
- ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦

### Security Tests
- æ¬Šé™æ§åˆ¶æ¸¬è©¦
- è³‡æ–™é©—è­‰æ¸¬è©¦
- æ•æ„Ÿè³‡æ–™ä¿è­·æ¸¬è©¦

---

## ğŸ”’ å®‰å…¨è€ƒé‡

### è³‡æ–™ä¿è­·
- å¯†ç¢¼é›œæ¹Šå„²å­˜
- æ•æ„Ÿè³‡æ–™ä¸å¤–æ´©
- PII è³‡æ–™ä¿è­·

### æ¬Šé™æ§åˆ¶
- åŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶
- API ç«¯é»æ¬Šé™é©—è­‰
- è³‡æ–™å­˜å–æ¬Šé™æ§åˆ¶

### éƒµä»¶å®‰å…¨
- é©—è­‰ token æ™‚æ•ˆæ€§
- é˜²æ­¢éƒµä»¶è½Ÿç‚¸
- å®‰å…¨çš„å¯†ç¢¼é‡è¨­æ©Ÿåˆ¶

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½éœ€æ±‚
- [ ] ç”¨æˆ¶å¯ä»¥è¨»å†Šæ–°å¸³è™Ÿ
- [ ] éƒµä»¶é©—è­‰æ©Ÿåˆ¶æ­£å¸¸
- [ ] ç”¨æˆ¶å¯ä»¥æ›´æ–°å€‹äººè³‡æ–™
- [ ] å¯†ç¢¼ä¿®æ”¹åŠŸèƒ½æ­£å¸¸
- [ ] ç®¡ç†å“¡å¯ä»¥ç®¡ç†ç”¨æˆ¶
- [ ] è§’è‰²æ¬Šé™æ§åˆ¶æ­£ç¢º

### éåŠŸèƒ½éœ€æ±‚
- [ ] API å›æ‡‰æ™‚é–“ < 300ms
- [ ] æ¸¬è©¦è¦†è“‹ç‡ > 90%
- [ ] éƒµä»¶ç™¼é€æˆåŠŸç‡ > 95%
- [ ] éŒ¯èª¤è™•ç†å®Œå–„

### å®‰å…¨éœ€æ±‚
- [ ] æ¬Šé™æ§åˆ¶æ©Ÿåˆ¶å®Œå–„
- [ ] æ•æ„Ÿè³‡æ–™ä¿è­·
- [ ] é˜²æ­¢å¸¸è¦‹æ”»æ“Š
- [ ] GDPR åˆè¦è€ƒé‡

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é …

### ç’°å¢ƒè®Šæ•¸
```bash
# .env
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
FROM_EMAIL=noreply@yourapp.com
FRONTEND_URL=https://yourapp.com
```

### éƒµä»¶æ¨¡æ¿
æº–å‚™ HTML éƒµä»¶æ¨¡æ¿æ–‡ä»¶ã€‚

### è³‡æ–™åº«ç´¢å¼•
ç‚ºå¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•ï¼š
- users.email
- users.username
- users.emailVerificationToken
- users.passwordResetToken

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

- ç”¨æˆ¶æŸ¥è©¢å›æ‡‰æ™‚é–“: < 100ms
- éƒµä»¶ç™¼é€æ™‚é–“: < 5s
- ç”¨æˆ¶è¨»å†Šæµç¨‹: < 2s
- å¤§é‡ç”¨æˆ¶æŸ¥è©¢: < 500ms