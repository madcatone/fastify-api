# TASK 2: è³‡æ–™åº«è¨­è¨ˆèˆ‡ Schema å®šç¾©

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

æ“´å±•è³‡æ–™åº« Schema è¨­è¨ˆï¼Œå»ºç«‹ todos è¡¨æ ¼çµæ§‹ï¼Œå®šç¾©å®Œæ•´çš„è³‡æ–™æ¨¡å‹å’Œå‹åˆ¥ç³»çµ±ã€‚

### ğŸ¯ ç›®æ¨™
- è¨­è¨ˆ todos è¡¨æ ¼çµæ§‹
- å»ºç«‹å®Œæ•´çš„å‹åˆ¥å®šç¾©
- å¯¦ç¾è³‡æ–™é©—è­‰æ©Ÿåˆ¶
- è¨­ç½®è³‡æ–™åº«åˆå§‹åŒ–

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… TASK 1: Drizzle ORM å·²å®‰è£é…ç½®
- âœ… PostgreSQL è³‡æ–™åº«å·²å»ºç«‹
- âœ… åŸºç¤é€£æ¥å·²æ¸¬è©¦

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ—„ï¸ Todos è¡¨æ ¼è¨­è¨ˆ

#### æ¬„ä½å®šç¾©
| æ¬„ä½å | å‹åˆ¥ | æè¿° | ç´„æŸ |
|--------|------|------|------|
| id | UUID | å”¯ä¸€è­˜åˆ¥ç¬¦ | Primary Key, Auto Generate |
| content | TEXT | å¾…è¾¦äº‹é …å…§å®¹ | NOT NULL, æœ€å°‘ 1 å­—å…ƒ |
| author | TEXT | å»ºç«‹è€… | NOT NULL, æœ€å°‘ 1 å­—å…ƒ |
| createdAt | TIMESTAMP | å»ºç«‹æ™‚é–“ | NOT NULL, Default NOW() |
| updatedAt | TIMESTAMP | æ›´æ–°æ™‚é–“ | NOT NULL, Default NOW() |
| isActive | BOOLEAN | æ˜¯å¦å•Ÿç”¨ | NOT NULL, Default TRUE |

#### ç´¢å¼•è¨­è¨ˆ
- ä¸»ç´¢å¼•: `id` (Primary Key)
- è¤‡åˆç´¢å¼•: `author + createdAt` (æŸ¥è©¢å„ªåŒ–)
- éƒ¨åˆ†ç´¢å¼•: `isActive = true` (æ´»èºè¨˜éŒ„)

---

## ğŸ“ æª”æ¡ˆçµæ§‹

### æ–°å¢/æ›´æ–°æª”æ¡ˆ
```
packages/db/src/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ index.ts        # çµ±ä¸€ Schema ç®¡ç†
â”‚   â”œâ”€â”€ todos.ts        # Todos è¡¨æ ¼å®šç¾©
â”‚   â””â”€â”€ relations.ts    # è¡¨æ ¼é—œè¯å®šç¾© (é ç•™)
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ index.ts        # å‹åˆ¥çµ±ä¸€å°å‡º
â”‚   â””â”€â”€ todos.ts        # Todos ç›¸é—œå‹åˆ¥
â”œâ”€â”€ index.ts            # æ›´æ–°ä¸»è¦å°å‡º
â””â”€â”€ schema.ts           # å‘å¾Œå…¼å®¹å°å‡º
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: æ¨¡çµ„åŒ– Schema çµæ§‹

```typescript
// packages/db/src/schemas/todos.ts
import { pgTable, uuid, text, timestamp, boolean } from 'drizzle-orm/pg-core';

export const todos = pgTable('todos', {
  id: uuid('id').primaryKey().defaultRandom(),
  content: text('content').notNull(),
  author: text('author').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  isActive: boolean('is_active').default(true).notNull(),
});

// å‹åˆ¥æ¨æ–·
export type Todo = typeof todos.$inferSelect;
export type NewTodo = typeof todos.$inferInsert;
```

### Step 2: çµ±ä¸€ Schema ç®¡ç†

```typescript
// packages/db/src/schemas/index.ts
export * from './todos';

// é ç•™å…¶ä»–è¡¨æ ¼å°å‡º
// export * from './users';
// export * from './comments';
```

```typescript
// packages/db/src/schemas/relations.ts
import { relations } from 'drizzle-orm';
import { todos } from './todos';

// é ç•™è¡¨æ ¼é—œè¯å®šç¾©
// export const todosRelations = relations(todos, ({ many }) => ({
//   comments: many(comments),
// }));
```

### Step 3: å‹åˆ¥å®šç¾©ç³»çµ±

```typescript
// packages/db/src/types/todos.ts
import { z } from 'zod';
import type { Todo, NewTodo } from '../schemas/todos';

// Zod é©—è­‰ Schema
export const createTodoSchema = z.object({
  content: z.string().min(1, 'Content is required').max(1000, 'Content too long'),
  author: z.string().min(1, 'Author is required').max(100, 'Author name too long'),
});

export const updateTodoSchema = z.object({
  content: z.string().min(1).max(1000).optional(),
  author: z.string().min(1).max(100).optional(),
  isActive: z.boolean().optional(),
});

export const todoParamsSchema = z.object({
  id: z.string().uuid('Invalid UUID format'),
});

// TypeScript å‹åˆ¥
export type CreateTodoRequest = z.infer<typeof createTodoSchema>;
export type UpdateTodoRequest = z.infer<typeof updateTodoSchema>;
export type TodoParams = z.infer<typeof todoParamsSchema>;

// è³‡æ–™åº«å‹åˆ¥é‡æ–°å°å‡º
export type { Todo, NewTodo };
```

### Step 4: çµ±ä¸€å‹åˆ¥å°å‡º

```typescript
// packages/db/src/types/index.ts
export * from './todos';

// é€šç”¨å‹åˆ¥
export interface PaginationParams {
  page: number;
  limit: number;
}

export interface PaginationResult<T> {
  data: T[];
  total: number;
  page: number;
  limit: number;
  totalPages: number;
  hasNext: boolean;
  hasPrev: boolean;
}
```

### Step 5: æ›´æ–°ä¸»è¦å°å‡º

```typescript
// packages/db/src/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schemas';

const connectionString = process.env.DATABASE_URL || 
  'postgresql://postgres:temp1234@localhost:5432/fastify-development';

const client = postgres(connectionString);
export const db = drizzle(client, { schema });

// Schema å°å‡º
export * from './schemas';

// å‹åˆ¥å°å‡º
export * from './types';

// Drizzle æ“ä½œå‡½æ•¸å°å‡º
export { eq, and, or, like, sql, count, desc, asc } from 'drizzle-orm';
```

### Step 6: å‘å¾Œå…¼å®¹æ€§

```typescript
// packages/db/src/schema.ts
// å‘å¾Œå…¼å®¹çš„çµ±ä¸€å°å‡º
// æ‰€æœ‰æ–°çš„ schema å®šç¾©éƒ½åœ¨ schemas/ ç›®éŒ„ä¸­
export * from './schemas';
```

### Step 7: Drizzle é…ç½®æ›´æ–°

```typescript
// packages/db/drizzle.config.ts
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/schemas/*',  // æ”¯æ´ schemas ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆ
  out: './migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL || 
      'postgresql://postgres:temp1234@localhost:5432/fastify-development',
  },
} satisfies Config;
```

---

## ğŸ—„ï¸ è³‡æ–™åº«åˆå§‹åŒ–

### å»ºç«‹è³‡æ–™è¡¨ SQL
```sql
-- è‡ªå‹•ç”± Drizzle Kit ç”Ÿæˆ
CREATE TABLE IF NOT EXISTS "todos" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "content" text NOT NULL,
  "author" text NOT NULL,
  "created_at" timestamp DEFAULT now() NOT NULL,
  "updated_at" timestamp DEFAULT now() NOT NULL,
  "is_active" boolean DEFAULT true NOT NULL
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX IF NOT EXISTS "idx_todos_author_created" ON "todos" ("author", "created_at");
CREATE INDEX IF NOT EXISTS "idx_todos_active" ON "todos" ("is_active") WHERE "is_active" = true;
```

### ç¨®å­è³‡æ–™
```typescript
// packages/db/src/seed.ts
import { db, todos } from './index';

export async function seedTodos() {
  const sampleTodos = [
    {
      content: 'å®Œæˆ API æ¶æ§‹è¨­è¨ˆ',
      author: 'admin',
    },
    {
      content: 'å¯¦ä½œä½¿ç”¨è€…èªè­‰ç³»çµ±',
      author: 'developer',
    },
    {
      content: 'æ’°å¯« API æ–‡æª”',
      author: 'admin',
    },
    {
      content: 'è¨­è¨ˆè³‡æ–™åº« Schema',
      author: 'architect',
    },
    {
      content: 'å»ºç½®æ¸¬è©¦ç’°å¢ƒ',
      author: 'devops',
    },
  ];

  try {
    const inserted = await db.insert(todos).values(sampleTodos).returning();
    console.log(`âœ… æˆåŠŸæ’å…¥ ${inserted.length} ç­†ç¨®å­è³‡æ–™`);
    return inserted;
  } catch (error) {
    console.error('âŒ ç¨®å­è³‡æ–™æ’å…¥å¤±æ•—:', error);
    throw error;
  }
}

// ä¸»åŸ·è¡Œå‡½æ•¸
async function main() {
  console.log('ğŸŒ± é–‹å§‹è³‡æ–™åº«ç¨®å­è³‡æ–™åˆå§‹åŒ–...');
  await seedTodos();
  console.log('ğŸ‰ è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ!');
  process.exit(0);
}

if (require.main === module) {
  main().catch((error) => {
    console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
    process.exit(1);
  });
}
```

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### Schema é©—è­‰æ¸¬è©¦
```typescript
// æ¸¬è©¦ Schema å®šç¾©
import { todos, db } from './index';
import { describe, it, expect } from 'vitest';

describe('Todos Schema', () => {
  it('should have correct table structure', () => {
    expect(todos).toBeDefined();
    expect(todos.id).toBeDefined();
    expect(todos.content).toBeDefined();
    expect(todos.author).toBeDefined();
    expect(todos.createdAt).toBeDefined();
    expect(todos.updatedAt).toBeDefined();
    expect(todos.isActive).toBeDefined();
  });

  it('should support basic CRUD operations', async () => {
    // æ’å…¥æ¸¬è©¦
    const newTodo = await db.insert(todos).values({
      content: 'Test todo',
      author: 'Test Author'
    }).returning();

    expect(newTodo).toHaveLength(1);
    expect(newTodo[0].content).toBe('Test todo');
    expect(newTodo[0].author).toBe('Test Author');
    expect(newTodo[0].isActive).toBe(true);
  });
});
```

### å‹åˆ¥é©—è­‰æ¸¬è©¦
```typescript
// æ¸¬è©¦å‹åˆ¥æ¨æ–·
import type { Todo, NewTodo, CreateTodoRequest } from './types';

describe('Type Definitions', () => {
  it('should have correct type inference', () => {
    const todo: Todo = {
      id: '123e4567-e89b-12d3-a456-426614174000',
      content: 'Test content',
      author: 'Test author',
      createdAt: new Date(),
      updatedAt: new Date(),
      isActive: true,
    };

    const newTodo: NewTodo = {
      content: 'New todo',
      author: 'Author',
    };

    const createRequest: CreateTodoRequest = {
      content: 'Request content',
      author: 'Request author',
    };

    expect(todo).toBeDefined();
    expect(newTodo).toBeDefined();
    expect(createRequest).toBeDefined();
  });
});
```

---

## âœ… å®Œæˆæ¨™æº–

### æŠ€è¡“é©—æ”¶
- [x] Todos è¡¨æ ¼æˆåŠŸå»ºç«‹
- [x] å‹åˆ¥å®šç¾©å®Œæ•´ç„¡èª¤
- [x] ç´¢å¼•å»ºç«‹æ­£ç¢º
- [x] æ¨¡çµ„åŒ–çµæ§‹å®Œæˆ
- [x] å‘å¾Œå…¼å®¹æ€§ç¶­æŒ

### åŠŸèƒ½é©—æ”¶
- [x] CRUD æ“ä½œæ¸¬è©¦é€šé
- [x] å‹åˆ¥æ¨æ–·æ­£ç¢º
- [x] è³‡æ–™é©—è­‰æ©Ÿåˆ¶æ­£å¸¸
- [x] ç¨®å­è³‡æ–™æˆåŠŸæ’å…¥

### è³‡æ–™å®Œæ•´æ€§
- [x] ä¸»éµç´„æŸæ­£ç¢º
- [x] NOT NULL ç´„æŸç”Ÿæ•ˆ
- [x] é è¨­å€¼æ­£ç¢ºè¨­å®š
- [x] æ™‚é–“æˆ³è‡ªå‹•æ›´æ–°

---

## ğŸ” è³‡æ–™åº«ç®¡ç†å‘½ä»¤

### Drizzle Kit æ“ä½œ
```bash
# æ¨é€ Schema è®Šæ›´åˆ°è³‡æ–™åº«
npm run db:push

# é–‹å•Ÿ Drizzle Studio (è³‡æ–™åº«ç®¡ç†ç•Œé¢)
npm run db:studio

# ç”Ÿæˆé·ç§»æª”æ¡ˆ
npx drizzle-kit generate:pg

# åŸ·è¡Œé·ç§»
npx drizzle-kit migrate:pg
```

### æ‰‹å‹• SQL æ“ä½œ
```bash
# é€£æ¥è³‡æ–™åº«
psql -h localhost -U postgres -d fastify-development

# æŸ¥çœ‹è¡¨æ ¼çµæ§‹
\d todos

# æª¢æŸ¥è³‡æ–™
SELECT * FROM todos LIMIT 5;

# æª¢æŸ¥ç´¢å¼•
\di
```

---

## ğŸ“Š æ•ˆèƒ½è€ƒé‡

### æŸ¥è©¢æœ€ä½³åŒ–
- **ä¸»éµæŸ¥è©¢**: ä½¿ç”¨ UUID ä¸»éµï¼Œæ”¯æ´å¿«é€Ÿç²¾ç¢ºæŸ¥è©¢
- **è¤‡åˆç´¢å¼•**: author + createdAtï¼Œæ”¯æ´æŒ‰ä½œè€…å’Œæ™‚é–“æ’åº
- **éƒ¨åˆ†ç´¢å¼•**: åªå° isActive = true å»ºç«‹ç´¢å¼•ï¼Œç¯€çœç©ºé–“

### å„²å­˜æœ€ä½³åŒ–
- **é©ç•¶çš„æ¬„ä½å‹åˆ¥**: TEXT vs VARCHAR é¸æ“‡
- **åˆç†çš„é è¨­å€¼**: æ¸›å°‘ NULL å€¼å­˜å„²
- **æ™‚é–“æˆ³æœ€ä½³åŒ–**: ä½¿ç”¨ TIMESTAMP è€Œé TIMESTAMPTZ

---

## ğŸš€ å¾ŒçºŒæ“´å±•

### é ç•™æ“´å±•é»
- **é—œè¯è¡¨æ ¼**: é ç•™ relations.ts æª”æ¡ˆ
- **æ¬„ä½æ“´å±•**: å¯è¼•é¬†æ·»åŠ æ–°æ¬„ä½
- **ç´¢å¼•æœ€ä½³åŒ–**: æ ¹æ“šæŸ¥è©¢æ¨¡å¼èª¿æ•´ç´¢å¼•

### å¯èƒ½çš„æ“´å±•
```typescript
// æœªä¾†å¯èƒ½çš„æ“´å±•
export const todoCategories = pgTable('todo_categories', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull(),
  color: text('color'),
});

export const todoTags = pgTable('todo_tags', {
  todoId: uuid('todo_id').references(() => todos.id),
  tag: text('tag').notNull(),
});
```