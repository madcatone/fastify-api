# TASK 18: Docker å®¹å™¨åŒ–

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

å°‡ Fastify API å°ˆæ¡ˆå®¹å™¨åŒ–ï¼Œå»ºç«‹å®Œæ•´çš„ Docker éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…å«é–‹ç™¼ã€æ¸¬è©¦å’Œç”Ÿç”¢ç’°å¢ƒé…ç½®ã€‚

### ğŸ¯ ç›®æ¨™
- å»ºç«‹å¤šéšæ®µ Docker å»ºç½®
- é…ç½®é–‹ç™¼å’Œç”Ÿç”¢ç’°å¢ƒ
- æ•´åˆ PostgreSQL è³‡æ–™åº«å®¹å™¨
- è¨­ç½® Docker Compose ç·¨æ’
- å„ªåŒ–å®¹å™¨æ•ˆèƒ½å’Œå®‰å…¨æ€§

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… æ ¸å¿ƒåŠŸèƒ½é–‹ç™¼å®Œæˆ
- âœ… ç’°å¢ƒè®Šæ•¸é…ç½®å®Œå–„
- âœ… æ¸¬è©¦å¥—ä»¶ç©©å®šé‹è¡Œ

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ“ æª”æ¡ˆçµæ§‹

```
fastify-api/
â”œâ”€â”€ Dockerfile              # ä¸»è¦ Dockerfile
â”œâ”€â”€ Dockerfile.dev          # é–‹ç™¼ç’°å¢ƒ Dockerfile
â”œâ”€â”€ docker-compose.yml      # ç”Ÿç”¢ç’°å¢ƒç·¨æ’
â”œâ”€â”€ docker-compose.dev.yml  # é–‹ç™¼ç’°å¢ƒç·¨æ’
â”œâ”€â”€ docker-compose.test.yml # æ¸¬è©¦ç’°å¢ƒç·¨æ’
â”œâ”€â”€ .dockerignore           # Docker å¿½ç•¥æª”æ¡ˆ
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ nginx/              # Nginx é…ç½®
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ nginx.conf
â”‚   â”œâ”€â”€ postgres/           # PostgreSQL é…ç½®
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ init.sql
â”‚   â””â”€â”€ scripts/            # éƒ¨ç½²è…³æœ¬
â”‚       â”œâ”€â”€ build.sh
â”‚       â”œâ”€â”€ deploy.sh
â”‚       â””â”€â”€ health-check.sh
â””â”€â”€ .env.docker             # Docker ç’°å¢ƒè®Šæ•¸
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: ä¸»è¦ Dockerfile (å¤šéšæ®µå»ºç½®)

```dockerfile
# Dockerfile
# ========================================
# Stage 1: å»ºç½®éšæ®µ
# ========================================
FROM node:18-alpine AS builder

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ package æª”æ¡ˆ
COPY package*.json ./
COPY turbo.json ./
COPY apps/server/package*.json ./apps/server/
COPY packages/*/package*.json ./packages/*/

# å®‰è£ä¾è³´
RUN npm ci --only=production && npm cache clean --force

# è¤‡è£½æºç¢¼
COPY . .

# å»ºç½®æ‡‰ç”¨ç¨‹å¼
RUN npm run build

# ========================================
# Stage 2: ç”Ÿç”¢åŸ·è¡Œéšæ®µ
# ========================================
FROM node:18-alpine AS production

# å‰µå»ºé root ç”¨æˆ¶
RUN addgroup -g 1001 -S nodejs
RUN adduser -S fastify -u 1001

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# å¾å»ºç½®éšæ®µè¤‡è£½æª”æ¡ˆ
COPY --from=builder --chown=fastify:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=fastify:nodejs /app/apps/server/dist ./apps/server/dist
COPY --from=builder --chown=fastify:nodejs /app/packages ./packages
COPY --from=builder --chown=fastify:nodejs /app/package*.json ./

# å®‰è£å¥åº·æª¢æŸ¥å·¥å…·
RUN apk add --no-cache curl

# åˆ‡æ›åˆ°é root ç”¨æˆ¶
USER fastify

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
CMD ["node", "apps/server/dist/server.js"]
```

### Step 2: é–‹ç™¼ç’°å¢ƒ Dockerfile

```dockerfile
# Dockerfile.dev
FROM node:18-alpine

# å®‰è£é–‹ç™¼å·¥å…·
RUN apk add --no-cache git curl

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ package æª”æ¡ˆ
COPY package*.json ./
COPY turbo.json ./

# å®‰è£ä¾è³´ (åŒ…å«é–‹ç™¼ä¾è³´)
RUN npm install

# å‰µå»ºé root ç”¨æˆ¶
RUN addgroup -g 1001 -S nodejs
RUN adduser -S fastify -u 1001
RUN chown -R fastify:nodejs /app

# åˆ‡æ›ç”¨æˆ¶
USER fastify

# æš´éœ²ç«¯å£å’Œèª¿è©¦ç«¯å£
EXPOSE 8080 9229

# é–‹ç™¼æ¨¡å¼å•Ÿå‹•
CMD ["npm", "run", "dev"]
```

### Step 3: Docker Compose é…ç½®

```yaml
# docker-compose.yml (ç”Ÿç”¢ç’°å¢ƒ)
version: '3.8'

services:
  # Fastify API æœå‹™
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: fastify-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL è³‡æ–™åº«
  postgres:
    image: postgres:15-alpine
    container_name: fastify-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx åå‘ä»£ç†
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: fastify-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api
    networks:
      - app-network
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./logs/nginx:/var/log/nginx

  # Redis (å¿«å–)
  redis:
    image: redis:7-alpine
    container_name: fastify-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

### Step 4: é–‹ç™¼ç’°å¢ƒ Compose

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # é–‹ç™¼ API æœå‹™
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: fastify-api-dev
    environment:
      NODE_ENV: development
      PORT: 8080
      DATABASE_URL: postgresql://postgres:dev_password@postgres:5432/fastify_dev
    ports:
      - "8080:8080"
      - "9229:9229"  # Node.js èª¿è©¦ç«¯å£
    depends_on:
      - postgres
    networks:
      - dev-network
    volumes:
      - .:/app
      - /app/node_modules  # é˜²æ­¢è¦†è“‹å®¹å™¨å…§çš„ node_modules
    command: npm run dev

  # é–‹ç™¼è³‡æ–™åº«
  postgres:
    image: postgres:15-alpine
    container_name: fastify-postgres-dev
    environment:
      POSTGRES_DB: fastify_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dev_password
    ports:
      - "5432:5432"
    networks:
      - dev-network
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data

  # æ¸¬è©¦è³‡æ–™åº«
  postgres-test:
    image: postgres:15-alpine
    container_name: fastify-postgres-test
    environment:
      POSTGRES_DB: fastify_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: test_password
    ports:
      - "5433:5432"
    networks:
      - dev-network
    volumes:
      - postgres_test_data:/var/lib/postgresql/data

volumes:
  postgres_dev_data:
  postgres_test_data:

networks:
  dev-network:
    driver: bridge
```

### Step 5: Nginx é…ç½®

```dockerfile
# docker/nginx/Dockerfile
FROM nginx:alpine

# è¤‡è£½é…ç½®æª”æ¡ˆ
COPY nginx.conf /etc/nginx/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80 443

# å•Ÿå‹• Nginx
CMD ["nginx", "-g", "daemon off;"]
```

```nginx
# docker/nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:8080;
    }

    # é™åˆ¶è«‹æ±‚å¤§å°
    client_max_body_size 10M;

    # Gzip å£“ç¸®
    gzip on;
    gzip_types text/plain application/json application/javascript text/css;

    server {
        listen 80;
        server_name localhost;

        # å¥åº·æª¢æŸ¥
        location /health {
            proxy_pass http://api/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # API è·¯ç”±
        location /api/ {
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # API æ–‡æª”
        location /docs {
            proxy_pass http://api/docs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # éœæ…‹æª”æ¡ˆ (å¦‚æœæœ‰)
        location / {
            return 404;
        }
    }
}
```

### Step 6: éƒ¨ç½²è…³æœ¬

```bash
#!/bin/bash
# docker/scripts/build.sh

set -e

echo "ğŸ—ï¸  Building Fastify API Docker images..."

# å»ºç½®ç”Ÿç”¢ç’°å¢ƒæ˜ åƒ
docker build -t fastify-api:latest .

# å»ºç½®é–‹ç™¼ç’°å¢ƒæ˜ åƒ
docker build -f Dockerfile.dev -t fastify-api:dev .

echo "âœ… Docker images built successfully!"

# é¡¯ç¤ºæ˜ åƒè³‡è¨Š
docker images | grep fastify-api
```

```bash
#!/bin/bash
# docker/scripts/deploy.sh

set -e

echo "ğŸš€ Deploying Fastify API..."

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
if [ ! -f .env.docker ]; then
    echo "âŒ .env.docker file not found!"
    exit 1
fi

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
export $(cat .env.docker | xargs)

# åœæ­¢ç¾æœ‰å®¹å™¨
echo "ğŸ›‘ Stopping existing containers..."
docker-compose down

# æ‹‰å–æœ€æ–°æ˜ åƒ
echo "ğŸ“¥ Pulling latest images..."
docker-compose pull

# å•Ÿå‹•æœå‹™
echo "ğŸ”„ Starting services..."
docker-compose up -d

# ç­‰å¾…æœå‹™å•Ÿå‹•
echo "â³ Waiting for services to be ready..."
sleep 30

# å¥åº·æª¢æŸ¥
echo "ğŸ” Performing health check..."
if curl -f http://localhost/health; then
    echo "âœ… Deployment successful!"
else
    echo "âŒ Health check failed!"
    docker-compose logs api
    exit 1
fi
```

### Step 7: Docker å¿½ç•¥æª”æ¡ˆ

```gitignore
# .dockerignore
node_modules
npm-debug.log
.git
.gitignore
.env
.env.local
.env.*.local
dist
coverage
*.log
.DS_Store
Thumbs.db
.vscode
.idea
README.md
docs/
*.md
tests/
.github/
```

---

## ğŸ§ª æ¸¬è©¦é…ç½®

### å®¹å™¨åŒ–æ¸¬è©¦ç’°å¢ƒ
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      NODE_ENV: test
      DATABASE_URL: postgresql://postgres:test_password@postgres-test:5432/fastify_test
    depends_on:
      - postgres-test
    networks:
      - test-network
    volumes:
      - .:/app
      - /app/node_modules
    command: npm run test:run

  postgres-test:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: fastify_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: test_password
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### ç”Ÿç”¢ç’°å¢ƒå®‰å…¨æªæ–½
1. **é root ç”¨æˆ¶**: å®¹å™¨å…§ä½¿ç”¨éç‰¹æ¬Šç”¨æˆ¶
2. **æœ€å°åŒ–æ˜ åƒ**: ä½¿ç”¨ Alpine Linux åŸºç¤æ˜ åƒ
3. **å¥åº·æª¢æŸ¥**: å®šæœŸæª¢æŸ¥æœå‹™ç‹€æ…‹
4. **è³‡æºé™åˆ¶**: è¨­ç½® CPU å’Œè¨˜æ†¶é«”é™åˆ¶
5. **ç¶²è·¯éš”é›¢**: ä½¿ç”¨è‡ªå®šç¾©ç¶²è·¯

### ç’°å¢ƒè®Šæ•¸ç®¡ç†
```bash
# .env.docker
POSTGRES_DB=fastify_production
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your-secure-password
JWT_ACCESS_SECRET=your-jwt-access-secret
JWT_REFRESH_SECRET=your-jwt-refresh-secret
NODE_ENV=production
```

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½éœ€æ±‚
- [ ] å®¹å™¨æˆåŠŸå»ºç½®å’Œå•Ÿå‹•
- [ ] è³‡æ–™åº«é€£æ¥æ­£å¸¸
- [ ] API ç«¯é»å¯æ­£å¸¸å­˜å–
- [ ] å¥åº·æª¢æŸ¥æ©Ÿåˆ¶é‹ä½œ
- [ ] æ—¥èªŒè¨˜éŒ„æ­£å¸¸

### æ•ˆèƒ½éœ€æ±‚
- [ ] å®¹å™¨å•Ÿå‹•æ™‚é–“ < 30s
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ < 512MB
- [ ] CPU ä½¿ç”¨ç‡ < 50%
- [ ] æ˜ åƒå¤§å° < 200MB

### å®‰å…¨éœ€æ±‚
- [ ] é root ç”¨æˆ¶åŸ·è¡Œ
- [ ] æ•æ„Ÿè³‡æ–™ä¸æš´éœ²
- [ ] ç¶²è·¯å®‰å…¨é…ç½®
- [ ] å®¹å™¨æ¼æ´æƒæé€šé

---

## ğŸš€ éƒ¨ç½²æŒ‡ä»¤

### é–‹ç™¼ç’°å¢ƒ
```bash
# å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
docker-compose -f docker-compose.dev.yml up -d

# æŸ¥çœ‹æ—¥èªŒ
docker-compose -f docker-compose.dev.yml logs -f api

# åŸ·è¡Œæ¸¬è©¦
docker-compose -f docker-compose.test.yml up --abort-on-container-exit
```

### ç”Ÿç”¢ç’°å¢ƒ
```bash
# å»ºç½®æ˜ åƒ
./docker/scripts/build.sh

# éƒ¨ç½²æœå‹™
./docker/scripts/deploy.sh

# ç›£æ§æœå‹™
docker-compose logs -f
```

---

## ğŸ“Š ç›£æ§æŒ‡æ¨™

- å®¹å™¨å•Ÿå‹•æ™‚é–“: < 30s
- è¨˜æ†¶é«”ä½¿ç”¨ç‡: < 80%
- CPU ä½¿ç”¨ç‡: < 70%
- ç£ç¢Ÿ I/O: æ­£å¸¸ç¯„åœ
- ç¶²è·¯å»¶é²: < 10ms