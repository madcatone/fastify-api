# TASK 9: æ¬Šé™æ§åˆ¶èˆ‡ä¸­é–“ä»¶

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

å¯¦ç¾åŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶ (Role-Based Access Control, RBAC) ç³»çµ±ï¼Œæä¾›ç´°ç·»çš„æ¬Šé™ç®¡ç†åŠŸèƒ½ã€‚

### ğŸ¯ ç›®æ¨™
- å»ºç«‹éˆæ´»çš„æ¬Šé™æ§åˆ¶ç³»çµ±
- å¯¦ç¾è³‡æºç´šåˆ¥çš„å­˜å–æ§åˆ¶
- æä¾›æ¬Šé™ç®¡ç†ä»‹é¢
- æ•´åˆåˆ°ç¾æœ‰çš„ä¸­é–“ä»¶æ¶æ§‹

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… JWT èªè­‰ç³»çµ±å·²å¯¦ç¾ (TASK 7)
- âœ… ç”¨æˆ¶ç®¡ç†ç³»çµ±å·²å»ºç«‹ (TASK 8)
- âœ… ä¸­é–“ä»¶ç³»çµ±å·²å®Œæˆ

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ—„ï¸ è³‡æ–™åº« Schema è¨­è¨ˆ

```typescript
// packages/db/src/schemas/permissions.ts
export const permissions = pgTable('permissions', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull().unique(), // e.g., 'todos:read', 'users:write'
  description: text('description'),
  resource: text('resource').notNull(), // e.g., 'todos', 'users'
  action: text('action').notNull(), // e.g., 'read', 'write', 'delete'
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const roles = pgTable('roles', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: text('name').notNull().unique(), // e.g., 'user', 'moderator', 'admin'
  description: text('description'),
  isSystem: boolean('is_system').default(false).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const rolePermissions = pgTable('role_permissions', {
  id: uuid('id').primaryKey().defaultRandom(),
  roleId: uuid('role_id').references(() => roles.id).notNull(),
  permissionId: uuid('permission_id').references(() => permissions.id).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const userPermissions = pgTable('user_permissions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id).notNull(),
  permissionId: uuid('permission_id').references(() => permissions.id).notNull(),
  granted: boolean('granted').default(true).notNull(), // true: granted, false: denied
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

---

## ğŸ“ æª”æ¡ˆçµæ§‹

### æ–°å¢æª”æ¡ˆ
```
apps/server/src/
â”œâ”€â”€ permissions/
â”‚   â”œâ”€â”€ controller.ts      # æ¬Šé™ç®¡ç† Controller
â”‚   â”œâ”€â”€ service.ts         # æ¬Šé™ç®¡ç† Service
â”‚   â”œâ”€â”€ types.ts           # æ¬Šé™ç›¸é—œå‹åˆ¥å®šç¾©
â”‚   â””â”€â”€ routes.ts          # æ¬Šé™ç®¡ç†è·¯ç”±
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ permission.ts      # æ¬Šé™æª¢æŸ¥ä¸­é–“ä»¶
â”‚   â”œâ”€â”€ resource.ts        # è³‡æºå­˜å–ä¸­é–“ä»¶
â”‚   â””â”€â”€ rbac.ts            # RBAC æ ¸å¿ƒé‚è¼¯
â””â”€â”€ test/
    â””â”€â”€ permissions/
        â”œâ”€â”€ controller.test.ts
        â”œâ”€â”€ service.test.ts
        â”œâ”€â”€ middleware.test.ts
        â””â”€â”€ integration.test.ts
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: æ¬Šé™ç³»çµ±æ ¸å¿ƒé‚è¼¯

```typescript
// apps/server/src/permissions/types.ts
export interface Permission {
  id: string;
  name: string;
  description?: string;
  resource: string;
  action: string;
  createdAt: Date;
}

export interface Role {
  id: string;
  name: string;
  description?: string;
  isSystem: boolean;
  permissions: Permission[];
  createdAt: Date;
  updatedAt: Date;
}

export enum PermissionAction {
  READ = 'read',
  WRITE = 'write',
  DELETE = 'delete',
  ADMIN = 'admin'
}

export enum ResourceType {
  TODOS = 'todos',
  USERS = 'users',
  ROLES = 'roles',
  PERMISSIONS = 'permissions',
  SYSTEM = 'system'
}
```

### Step 2: æ¬Šé™æª¢æŸ¥æœå‹™

```typescript
// apps/server/src/permissions/service.ts
export class PermissionService {
  async getUserPermissions(userId: string): Promise<Permission[]>
  async checkUserPermission(userId: string, resource: string, action: string): Promise<boolean>
  async getUserRoles(userId: string): Promise<Role[]>
  async assignRoleToUser(userId: string, roleId: string): Promise<boolean>
  async removeRoleFromUser(userId: string, roleId: string): Promise<boolean>
  async grantPermissionToUser(userId: string, permissionId: string): Promise<boolean>
  async revokePermissionFromUser(userId: string, permissionId: string): Promise<boolean>
  
  // è§’è‰²ç®¡ç†
  async createRole(data: CreateRoleRequest): Promise<Role>
  async updateRole(id: string, data: UpdateRoleRequest): Promise<Role>
  async deleteRole(id: string): Promise<boolean>
  async getAllRoles(): Promise<Role[]>
  async assignPermissionToRole(roleId: string, permissionId: string): Promise<boolean>
  async removePermissionFromRole(roleId: string, permissionId: string): Promise<boolean>
  
  // æ¬Šé™ç®¡ç†
  async createPermission(data: CreatePermissionRequest): Promise<Permission>
  async getAllPermissions(): Promise<Permission[]>
  async getPermissionsByResource(resource: string): Promise<Permission[]>
}
```

### Step 3: RBAC ä¸­é–“ä»¶ç³»çµ±

```typescript
// apps/server/src/middleware/rbac.ts
export class RBACMiddleware {
  static requirePermission(resource: string, action: string) {
    return async (request: FastifyRequest, reply: FastifyReply) => {
      const user = request.user;
      if (!user) {
        return reply.status(401).send({ error: 'Authentication required' });
      }
      
      const hasPermission = await permissionService.checkUserPermission(
        user.id, 
        resource, 
        action
      );
      
      if (!hasPermission) {
        return reply.status(403).send({ 
          error: 'Insufficient permissions',
          required: `${resource}:${action}`
        });
      }
    };
  }
  
  static requireRole(roleName: string) {
    return async (request: FastifyRequest, reply: FastifyReply) => {
      // è§’è‰²æª¢æŸ¥é‚è¼¯
    };
  }
  
  static requireOwnership(resourceField: string = 'userId') {
    return async (request: FastifyRequest, reply: FastifyReply) => {
      // è³‡æºæ“æœ‰æ¬Šæª¢æŸ¥é‚è¼¯
    };
  }
}
```

### Step 4: è³‡æºå­˜å–æ§åˆ¶

```typescript
// apps/server/src/middleware/resource.ts
export const resourceAccessControl = {
  todos: {
    read: RBACMiddleware.requirePermission('todos', 'read'),
    write: RBACMiddleware.requirePermission('todos', 'write'),
    delete: RBACMiddleware.requirePermission('todos', 'delete'),
    own: RBACMiddleware.requireOwnership('author'), // åªèƒ½å­˜å–è‡ªå·±çš„ todos
  },
  users: {
    read: RBACMiddleware.requirePermission('users', 'read'),
    write: RBACMiddleware.requirePermission('users', 'write'),
    admin: RBACMiddleware.requirePermission('users', 'admin'),
  }
};
```

### Step 5: æ¬Šé™ç®¡ç† Controller

```typescript
// apps/server/src/permissions/controller.ts
export class PermissionController {
  // æ¬Šé™æŸ¥è©¢
  async getUserPermissions(request: FastifyRequest, reply: FastifyReply)
  async checkPermission(request: FastifyRequest, reply: FastifyReply)
  
  // è§’è‰²ç®¡ç† (éœ€è¦ç®¡ç†å“¡æ¬Šé™)
  async getAllRoles(request: FastifyRequest, reply: FastifyReply)
  async createRole(request: FastifyRequest, reply: FastifyReply)
  async updateRole(request: FastifyRequest, reply: FastifyReply)
  async deleteRole(request: FastifyRequest, reply: FastifyReply)
  async assignRoleToUser(request: FastifyRequest, reply: FastifyReply)
  
  // æ¬Šé™ç®¡ç† (éœ€è¦ç³»çµ±ç®¡ç†å“¡æ¬Šé™)
  async getAllPermissions(request: FastifyRequest, reply: FastifyReply)
  async createPermission(request: FastifyRequest, reply: FastifyReply)
  async grantPermissionToUser(request: FastifyRequest, reply: FastifyReply)
  async revokePermissionFromUser(request: FastifyRequest, reply: FastifyReply)
}
```

### Step 6: é è¨­æ¬Šé™å’Œè§’è‰²åˆå§‹åŒ–

```typescript
// apps/server/src/permissions/seed.ts
export const seedPermissionsAndRoles = async () => {
  // å‰µå»ºåŸºæœ¬æ¬Šé™
  const permissions = [
    { name: 'todos:read', resource: 'todos', action: 'read' },
    { name: 'todos:write', resource: 'todos', action: 'write' },
    { name: 'todos:delete', resource: 'todos', action: 'delete' },
    { name: 'users:read', resource: 'users', action: 'read' },
    { name: 'users:write', resource: 'users', action: 'write' },
    { name: 'users:admin', resource: 'users', action: 'admin' },
  ];
  
  // å‰µå»ºåŸºæœ¬è§’è‰²
  const roles = [
    { 
      name: 'user', 
      permissions: ['todos:read', 'todos:write', 'todos:delete'] 
    },
    { 
      name: 'moderator', 
      permissions: ['todos:read', 'todos:write', 'users:read'] 
    },
    { 
      name: 'admin', 
      permissions: ['*'] // æ‰€æœ‰æ¬Šé™
    }
  ];
};
```

---

## ğŸ“‹ API ç«¯é»è¨­è¨ˆ

### æ¬Šé™æŸ¥è©¢

#### GET /permissions/me
å–å¾—ç•¶å‰ç”¨æˆ¶çš„æ‰€æœ‰æ¬Šé™
```json
{
  "success": true,
  "data": {
    "permissions": [
      {
        "name": "todos:read",
        "resource": "todos",
        "action": "read"
      }
    ],
    "roles": ["user"]
  }
}
```

#### POST /permissions/check
æª¢æŸ¥ç‰¹å®šæ¬Šé™
```json
{
  "resource": "todos",
  "action": "write"
}
```

### è§’è‰²ç®¡ç† (ç®¡ç†å“¡åŠŸèƒ½)

#### GET /admin/roles
å–å¾—æ‰€æœ‰è§’è‰²

#### POST /admin/roles
å‰µå»ºæ–°è§’è‰²
```json
{
  "name": "editor",
  "description": "Content editor role",
  "permissions": ["todos:read", "todos:write"]
}
```

#### PUT /admin/users/:userId/roles
åˆ†é…è§’è‰²çµ¦ç”¨æˆ¶
```json
{
  "roles": ["moderator"]
}
```

### æ¬Šé™ç®¡ç† (è¶…ç´šç®¡ç†å“¡åŠŸèƒ½)

#### GET /admin/permissions
å–å¾—æ‰€æœ‰æ¬Šé™

#### POST /admin/permissions
å‰µå»ºæ–°æ¬Šé™
```json
{
  "name": "comments:moderate",
  "resource": "comments",
  "action": "moderate",
  "description": "Moderate user comments"
}
```

---

## ğŸ”§ è·¯ç”±æ•´åˆç¯„ä¾‹

### æ›´æ–° Todos è·¯ç”±
```typescript
// apps/server/src/todos/routes.ts
export async function todoRoutes(fastify: FastifyInstance) {
  // éœ€è¦è®€å–æ¬Šé™
  fastify.get('/api/v1/todos', {
    preHandler: [
      jwtAuthMiddleware,
      resourceAccessControl.todos.read
    ],
    handler: todoController.getAllTodos
  });
  
  // éœ€è¦å¯«å…¥æ¬Šé™
  fastify.post('/api/v1/todos', {
    preHandler: [
      jwtAuthMiddleware,
      resourceAccessControl.todos.write
    ],
    handler: todoController.createTodo
  });
  
  // éœ€è¦åˆªé™¤æ¬Šé™æˆ–æ“æœ‰æ¬Š
  fastify.delete('/api/v1/todos/:id', {
    preHandler: [
      jwtAuthMiddleware,
      async (request, reply) => {
        // æª¢æŸ¥æ˜¯å¦æœ‰åˆªé™¤æ¬Šé™æˆ–æ˜¯è³‡æºæ“æœ‰è€…
        const hasDeletePermission = await permissionService.checkUserPermission(
          request.user.id, 'todos', 'delete'
        );
        
        if (!hasDeletePermission) {
          // æª¢æŸ¥æ“æœ‰æ¬Š
          await resourceAccessControl.todos.own(request, reply);
        }
      }
    ],
    handler: todoController.deleteTodo
  });
}
```

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### Unit Tests
- PermissionService æ¥­å‹™é‚è¼¯æ¸¬è©¦
- RBAC ä¸­é–“ä»¶æ¸¬è©¦
- æ¬Šé™æª¢æŸ¥é‚è¼¯æ¸¬è©¦

### Integration Tests
- å®Œæ•´æ¬Šé™æ§åˆ¶æµç¨‹æ¸¬è©¦
- è§’è‰²åˆ†é…å’Œæ¬Šé™æª¢æŸ¥æ¸¬è©¦
- è³‡æºå­˜å–æ§åˆ¶æ¸¬è©¦

### Security Tests
- æ¬Šé™æå‡æ”»æ“Šæ¸¬è©¦
- æœªæˆæ¬Šå­˜å–æ¸¬è©¦
- è§’è‰²æ¬Šé™é‚Šç•Œæ¸¬è©¦

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½éœ€æ±‚
- [ ] ç”¨æˆ¶æ¬Šé™æª¢æŸ¥æ­£ç¢º
- [ ] è§’è‰²åˆ†é…åŠŸèƒ½æ­£å¸¸
- [ ] è³‡æºå­˜å–æ§åˆ¶æœ‰æ•ˆ
- [ ] æ¬Šé™ç®¡ç†ä»‹é¢æ­£å¸¸
- [ ] é è¨­è§’è‰²å’Œæ¬Šé™æ­£ç¢º

### å®‰å…¨éœ€æ±‚
- [ ] é˜²æ­¢æ¬Šé™æå‡æ”»æ“Š
- [ ] æœ€å°æ¬Šé™åŸå‰‡
- [ ] æ¬Šé™æª¢æŸ¥æ€§èƒ½è‰¯å¥½
- [ ] å¯©è¨ˆæ—¥èªŒå®Œæ•´

### æ•ˆèƒ½éœ€æ±‚
- [ ] æ¬Šé™æª¢æŸ¥æ™‚é–“ < 10ms
- [ ] è§’è‰²æŸ¥è©¢æ™‚é–“ < 50ms
- [ ] æ”¯æ´å¤§é‡ç”¨æˆ¶ä½µç™¼

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é …

### è³‡æ–™åº«åˆå§‹åŒ–
åŸ·è¡Œæ¬Šé™å’Œè§’è‰²çš„åˆå§‹åŒ–è…³æœ¬ã€‚

### å‘å¾Œå…¼å®¹æ€§
ç¢ºä¿ç¾æœ‰ç”¨æˆ¶çš„æ¬Šé™æ­£ç¢ºé·ç§»ã€‚

### æ•ˆèƒ½å„ªåŒ–
- æ¬Šé™è³‡æ–™å¿«å–
- è³‡æ–™åº«ç´¢å¼•å„ªåŒ–
- æŸ¥è©¢æ•ˆèƒ½ç›£æ§

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

- æ¬Šé™æª¢æŸ¥å›æ‡‰æ™‚é–“: < 10ms
- è§’è‰²æŸ¥è©¢å›æ‡‰æ™‚é–“: < 50ms
- æ¬Šé™ç®¡ç†æ“ä½œ: < 200ms
- ä½µç™¼æ¬Šé™æª¢æŸ¥: 1000+ req/sec