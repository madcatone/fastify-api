# TASK 10: OpenAPI/Swagger Êï¥Âêà

## üìã ‰ªªÂãôÊ¶ÇËø∞

Êï¥Âêà OpenAPI (Swagger) ÊñáÊ™îÁ≥ªÁµ±ÔºåËá™ÂãïÁîüÊàê API ÊñáÊ™îÔºåÊèê‰æõ‰∫íÂãïÂºè API Ê∏¨Ë©¶‰ªãÈù¢„ÄÇ

### üéØ ÁõÆÊ®ô
- Ëá™ÂãïÁîüÊàê OpenAPI 3.0 Ë¶èÊ†ºÊñáÊ™î
- Êèê‰æõ Swagger UI ‰∫íÂãï‰ªãÈù¢
- Êï¥ÂêàÂà∞ÁèæÊúâÁöÑ Fastify Êû∂Êßã
- ÊîØÊè¥Ë™çË≠âÂíåÊ¨äÈôêÁ≥ªÁµ±
- ÁîüÊàê TypeScript ÂÆ¢Êà∂Á´ØÁ®ãÂºèÁ¢º

### üìä ÂâçÁΩÆÊ¢ù‰ª∂
- ‚úÖ Âü∫Á§é API Êû∂ÊßãÂ∑≤ÂÆåÊàê
- ‚úÖ Ë™çË≠âÁ≥ªÁµ±Â∑≤ÂØ¶Áèæ (TASK 7-9)
- ‚úÖ ÊâÄÊúâ API Á´ØÈªûÂ∑≤ÂÆöÁæ©

---

## üèóÔ∏è ÊäÄË°ìË¶èÊ†º

### üîß ‰æùË≥¥Â•ó‰ª∂
```bash
npm install @fastify/swagger @fastify/swagger-ui
npm install --save-dev swagger-jsdoc @types/swagger-jsdoc
```

### üìÅ Ê™îÊ°àÁµêÊßã

```
apps/server/src/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ schemas/           # OpenAPI Schema ÂÆöÁæ©
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common.ts      # ÈÄöÁî® Schema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts        # Ë™çË≠âÁõ∏Èóú Schema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ todos.ts       # Todos Schema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.ts       # Áî®Êà∂ Schema
‚îÇ   ‚îú‚îÄ‚îÄ config.ts          # Swagger ÈÖçÁΩÆ
‚îÇ   ‚îî‚îÄ‚îÄ generator.ts       # ÊñáÊ™îÁîüÊàêÂô®
‚îú‚îÄ‚îÄ openapi/
‚îÇ   ‚îú‚îÄ‚îÄ openapi.json       # ÁîüÊàêÁöÑ OpenAPI Ë¶èÊ†º
‚îÇ   ‚îî‚îÄ‚îÄ client/            # ÁîüÊàêÁöÑÂÆ¢Êà∂Á´ØÁ®ãÂºèÁ¢º
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ docs/
        ‚îî‚îÄ‚îÄ openapi.test.ts
```

---

## üî® ÂØ¶ÊñΩÊ≠•È©ü

### Step 1: Swagger Âü∫Á§éÈÖçÁΩÆ

```typescript
// apps/server/src/docs/config.ts
export const swaggerConfig = {
  openapi: {
    openapi: '3.0.3',
    info: {
      title: 'Fastify API Documentation',
      description: 'A modern TypeScript backend API with Fastify + Drizzle ORM + PostgreSQL',
      version: '1.0.0',
      contact: {
        name: 'API Support',
        email: 'support@fastify-api.com'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'http://localhost:8080',
        description: 'Development server'
      },
      {
        url: 'https://api.yourapp.com',
        description: 'Production server'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'JWT Authorization header using the Bearer scheme'
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  swaggerUiOptions: {
    routePrefix: '/docs',
    exposeRoute: true,
    staticCSP: true,
    transformStaticCSP: (header: string) => header,
    uiConfig: {
      docExpansion: 'list',
      deepLinking: false,
      defaultModelsExpandDepth: 2,
      defaultModelExpandDepth: 2
    }
  }
};
```

### Step 2: Schema ÂÆöÁæ©

```typescript
// apps/server/src/docs/schemas/common.ts
export const commonSchemas = {
  Error: {
    type: 'object',
    required: ['success', 'error'],
    properties: {
      success: { type: 'boolean', example: false },
      error: { type: 'string', example: 'Error message' },
      details: {
        type: 'array',
        items: {
          type: 'object',
          properties: {
            field: { type: 'string' },
            message: { type: 'string' }
          }
        }
      }
    }
  },
  
  SuccessResponse: {
    type: 'object',
    required: ['success', 'data'],
    properties: {
      success: { type: 'boolean', example: true },
      data: { type: 'object' }
    }
  },
  
  Pagination: {
    type: 'object',
    properties: {
      page: { type: 'integer', example: 1 },
      limit: { type: 'integer', example: 10 },
      total: { type: 'integer', example: 100 },
      totalPages: { type: 'integer', example: 10 },
      hasNext: { type: 'boolean', example: true },
      hasPrev: { type: 'boolean', example: false }
    }
  }
};
```

```typescript
// apps/server/src/docs/schemas/todos.ts
export const todoSchemas = {
  Todo: {
    type: 'object',
    required: ['id', 'content', 'author', 'createdAt', 'updatedAt', 'isActive'],
    properties: {
      id: { 
        type: 'string', 
        format: 'uuid',
        example: '550e8400-e29b-41d4-a716-446655440000'
      },
      content: { 
        type: 'string', 
        example: 'Complete the API documentation'
      },
      author: { 
        type: 'string', 
        example: 'john_doe'
      },
      createdAt: { 
        type: 'string', 
        format: 'date-time',
        example: '2024-01-15T10:30:00.000Z'
      },
      updatedAt: { 
        type: 'string', 
        format: 'date-time',
        example: '2024-01-15T10:30:00.000Z'
      },
      isActive: { 
        type: 'boolean', 
        example: true
      }
    }
  },
  
  CreateTodoRequest: {
    type: 'object',
    required: ['content', 'author'],
    properties: {
      content: {
        type: 'string',
        minLength: 1,
        example: 'Complete the API documentation'
      },
      author: {
        type: 'string',
        minLength: 1,
        example: 'john_doe'
      }
    }
  },
  
  UpdateTodoRequest: {
    type: 'object',
    properties: {
      content: {
        type: 'string',
        minLength: 1,
        example: 'Updated content'
      },
      author: {
        type: 'string',
        minLength: 1,
        example: 'jane_doe'
      },
      isActive: {
        type: 'boolean',
        example: false
      }
    }
  },
  
  TodosResponse: {
    allOf: [
      { $ref: '#/components/schemas/SuccessResponse' },
      {
        type: 'object',
        properties: {
          data: {
            type: 'object',
            properties: {
              todos: {
                type: 'array',
                items: { $ref: '#/components/schemas/Todo' }
              },
              pagination: { $ref: '#/components/schemas/Pagination' },
              filters: {
                type: 'object',
                properties: {
                  author: { type: 'string' },
                  isActive: { type: 'boolean' },
                  search: { type: 'string' }
                }
              }
            }
          }
        }
      }
    ]
  }
};
```

### Step 3: Ë∑ØÁî±ÊñáÊ™îË®ªËß£

```typescript
// apps/server/src/todos/routes.ts (Êõ¥Êñ∞)
export async function todoRoutes(fastify: FastifyInstance) {
  // GET /api/v1/todos
  fastify.get('/api/v1/todos', {
    schema: {
      description: 'Get all todos with pagination and filtering',
      tags: ['Todos'],
      security: [{ bearerAuth: [] }],
      querystring: {
        type: 'object',
        properties: {
          page: { 
            type: 'integer', 
            minimum: 1, 
            default: 1,
            description: 'Page number'
          },
          limit: { 
            type: 'integer', 
            minimum: 1, 
            maximum: 100, 
            default: 10,
            description: 'Items per page'
          },
          author: { 
            type: 'string',
            description: 'Filter by author'
          },
          isActive: { 
            type: 'boolean',
            description: 'Filter by active status'
          },
          search: { 
            type: 'string',
            description: 'Search in todo content'
          }
        }
      },
      response: {
        200: { $ref: '#/components/schemas/TodosResponse' },
        400: { $ref: '#/components/schemas/Error' },
        401: { $ref: '#/components/schemas/Error' },
        500: { $ref: '#/components/schemas/Error' }
      }
    },
    preHandler: [jwtAuthMiddleware],
    handler: todoController.getAllTodos
  });
  
  // POST /api/v1/todos
  fastify.post('/api/v1/todos', {
    schema: {
      description: 'Create a new todo',
      tags: ['Todos'],
      security: [{ bearerAuth: [] }],
      body: { $ref: '#/components/schemas/CreateTodoRequest' },
      response: {
        201: {
          allOf: [
            { $ref: '#/components/schemas/SuccessResponse' },
            {
              type: 'object',
              properties: {
                data: { $ref: '#/components/schemas/Todo' }
              }
            }
          ]
        },
        400: { $ref: '#/components/schemas/Error' },
        401: { $ref: '#/components/schemas/Error' },
        500: { $ref: '#/components/schemas/Error' }
      }
    },
    preHandler: [jwtAuthMiddleware],
    handler: todoController.createTodo
  });
}
```

### Step 4: Ë™çË≠âÁõ∏ÈóúÊñáÊ™î

```typescript
// apps/server/src/docs/schemas/auth.ts
export const authSchemas = {
  LoginRequest: {
    type: 'object',
    required: ['email', 'password'],
    properties: {
      email: {
        type: 'string',
        format: 'email',
        example: 'user@example.com'
      },
      password: {
        type: 'string',
        minLength: 6,
        example: 'password123'
      }
    }
  },
  
  LoginResponse: {
    allOf: [
      { $ref: '#/components/schemas/SuccessResponse' },
      {
        type: 'object',
        properties: {
          data: {
            type: 'object',
            properties: {
              user: { $ref: '#/components/schemas/User' },
              accessToken: { 
                type: 'string',
                example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
              },
              refreshToken: { 
                type: 'string',
                example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
              }
            }
          }
        }
      }
    ]
  }
};
```

### Step 5: ‰º∫ÊúçÂô®Êï¥Âêà

```typescript
// apps/server/src/server.ts (Êõ¥Êñ∞)
import { swaggerConfig } from './docs/config';
import { registerSwagger } from './docs/generator';

const fastify = Fastify({
  logger: config.server.env === 'development',
});

// Ë®ªÂÜä Swagger
await registerSwagger(fastify);

// Ë®ªÂÜäÂÖ∂‰ªñÊèí‰ª∂ÂíåË∑ØÁî±...
```

```typescript
// apps/server/src/docs/generator.ts
import { FastifyInstance } from 'fastify';
import { swaggerConfig } from './config';
import { commonSchemas } from './schemas/common';
import { todoSchemas } from './schemas/todos';
import { authSchemas } from './schemas/auth';

export const registerSwagger = async (fastify: FastifyInstance) => {
  // Ë®ªÂÜä Swagger Êèí‰ª∂
  await fastify.register(require('@fastify/swagger'), {
    ...swaggerConfig.openapi,
    components: {
      ...swaggerConfig.openapi.components,
      schemas: {
        ...commonSchemas,
        ...todoSchemas,
        ...authSchemas
      }
    }
  });

  // Ë®ªÂÜä Swagger UI
  await fastify.register(require('@fastify/swagger-ui'), 
    swaggerConfig.swaggerUiOptions
  );
  
  // Âú®ÈñãÁôºÁí∞Â¢É‰∏≠Ëá™ÂãïÁîüÊàê OpenAPI Ê™îÊ°à
  if (process.env.NODE_ENV === 'development') {
    fastify.ready(() => {
      fastify.swagger();
    });
  }
};
```

### Step 6: ÂÆ¢Êà∂Á´ØÁ®ãÂºèÁ¢ºÁîüÊàê

```typescript
// apps/server/src/docs/generator.ts (Êì¥Â±ï)
export const generateOpenAPISpec = async (fastify: FastifyInstance) => {
  const spec = fastify.swagger();
  
  // ÂÑ≤Â≠ò OpenAPI Ë¶èÊ†º
  const fs = require('fs');
  const path = require('path');
  
  const outputPath = path.join(__dirname, '../openapi/openapi.json');
  fs.writeFileSync(outputPath, JSON.stringify(spec, null, 2));
  
  console.log('OpenAPI specification generated at:', outputPath);
  return spec;
};

// ÁîüÊàê TypeScript ÂÆ¢Êà∂Á´Ø
export const generateTypeScriptClient = async () => {
  const { execSync } = require('child_process');
  
  try {
    // ‰ΩøÁî® openapi-generator-cli ÁîüÊàêÂÆ¢Êà∂Á´Ø
    execSync(`
      npx @openapitools/openapi-generator-cli generate \
        -i src/openapi/openapi.json \
        -g typescript-fetch \
        -o src/openapi/client \
        --additional-properties=typescriptThreePlus=true
    `);
    
    console.log('TypeScript client generated successfully');
  } catch (error) {
    console.error('Failed to generate TypeScript client:', error);
  }
};
```

---

## üìã API ÊñáÊ™îÂäüËÉΩ

### üåê Swagger UI ÂäüËÉΩ
- **‰∫íÂãïÂºè API Ê∏¨Ë©¶**: Áõ¥Êé•Âú®ÁÄèË¶ΩÂô®‰∏≠Ê∏¨Ë©¶ API
- **Ë™çË≠âÊï¥Âêà**: ÊîØÊè¥ JWT Bearer token Ë™çË≠â
- **Âç≥ÊôÇÂõûÊáâ**: Êü•Áúã API ÂõûÊáâÂíåÈåØË™§Ë®äÊÅØ
- **Schema È©óË≠â**: Ëá™ÂãïÈ©óË≠âË´ãÊ±ÇÂíåÂõûÊáâÊ†ºÂºè

### üìä ÊñáÊ™îÂÖßÂÆπ
- **API Á´ØÈªû**: ÂÆåÊï¥ÁöÑÁ´ØÈªûÂàóË°®ÂíåË™™Êòé
- **Ë´ãÊ±Ç/ÂõûÊáâ Schema**: Ë©≥Á¥∞ÁöÑË≥áÊñôÊ†ºÂºèÂÆöÁæ©
- **ÈåØË™§Á¢ºË™™Êòé**: ÂêÑÁ®ÆÈåØË™§ÊÉÖÊ≥ÅÁöÑË™™Êòé
- **ÁØÑ‰æãË≥áÊñô**: ÂØ¶ÈöõÁöÑË´ãÊ±ÇÂíåÂõûÊáâÁØÑ‰æã

---

## üß™ Ê∏¨Ë©¶Á≠ñÁï•

### Documentation Tests
```typescript
// apps/server/src/test/docs/openapi.test.ts
describe('OpenAPI Documentation', () => {
  it('should generate valid OpenAPI specification', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // È©óË≠â OpenAPI Ë¶èÊ†ºÊ†ºÂºè
    expect(spec.openapi).toBe('3.0.3');
    expect(spec.info).toBeDefined();
    expect(spec.paths).toBeDefined();
    expect(spec.components.schemas).toBeDefined();
  });
  
  it('should include all API endpoints', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // Ê™¢Êü•ÊâÄÊúâÈáçË¶ÅÁ´ØÈªûÊòØÂê¶ÂåÖÂê´Âú®ÊñáÊ™î‰∏≠
    expect(spec.paths['/api/v1/todos']).toBeDefined();
    expect(spec.paths['/auth/login']).toBeDefined();
  });
  
  it('should have valid schema definitions', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // Ê™¢Êü• Schema ÂÆöÁæ©
    expect(spec.components.schemas.Todo).toBeDefined();
    expect(spec.components.schemas.User).toBeDefined();
  });
});
```

---

## ‚úÖ È©óÊî∂Ê®ôÊ∫ñ

### ÂäüËÉΩÈúÄÊ±Ç
- [ ] Swagger UI Ê≠£Â∏∏ÈÅã‰Ωú
- [ ] ÊâÄÊúâ API Á´ØÈªûÂ∑≤Ë®òÈåÑ
- [ ] Ë™çË≠âÂäüËÉΩÊ≠£Â∏∏Êï¥Âêà
- [ ] Schema È©óË≠âÊ≠£Á¢∫
- [ ] ÁØÑ‰æãË≥áÊñôÊ∫ñÁ¢∫

### ÂìÅË≥™ÈúÄÊ±Ç
- [ ] ÊñáÊ™îÂÖßÂÆπÂÆåÊï¥
- [ ] ÁØÑ‰æãË≥áÊñôÂØ¶Áî®
- [ ] ÈåØË™§Ë™™ÊòéÊ∏ÖÊ•ö
- [ ] ‰∫íÂãïÊ∏¨Ë©¶ÂäüËÉΩÊ≠£Â∏∏

---

## üöÄ ÈÉ®ÁΩ≤ÈÖçÁΩÆ

### Áí∞Â¢ÉËÆäÊï∏
```bash
# .env
SWAGGER_ENABLED=true
SWAGGER_HOST=localhost:8080
API_BASE_URL=https://api.yourapp.com
```

### ÁîüÁî¢Áí∞Â¢ÉËÄÉÈáè
```typescript
// ÁîüÁî¢Áí∞Â¢ÉÂèØËÉΩÈúÄË¶ÅÈôêÂà∂ÊñáÊ™îÂ≠òÂèñ
if (process.env.NODE_ENV === 'production') {
  // ÂèØËÉΩÈúÄË¶ÅË™çË≠âÊâçËÉΩÂ≠òÂèñÊñáÊ™î
  swaggerUiOptions.routePrefix = '/internal/docs';
}
```

---

## üìä ÊïàËÉΩÊåáÊ®ô

- ÊñáÊ™îËºâÂÖ•ÊôÇÈñì: < 2s
- API Ê∏¨Ë©¶ÂõûÊáâÊôÇÈñì: < 500ms
- ÊñáÊ™îÊõ¥Êñ∞È†ªÁéá: ÊØèÊ¨°ÈÉ®ÁΩ≤Ëá™ÂãïÊõ¥Êñ∞
- ÂÆ¢Êà∂Á´ØÁî¢ÁîüÊôÇÈñì: < 30s