# TASK 10: OpenAPI/Swagger æ•´åˆ

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

æ•´åˆ OpenAPI (Swagger) æ–‡æª”ç³»çµ±ï¼Œè‡ªå‹•ç”Ÿæˆ API æ–‡æª”ï¼Œæä¾›äº’å‹•å¼ API æ¸¬è©¦ä»‹é¢ã€‚

### ğŸ¯ ç›®æ¨™
- è‡ªå‹•ç”Ÿæˆ OpenAPI 3.0 è¦æ ¼æ–‡æª”
- æä¾› Swagger UI äº’å‹•ä»‹é¢
- æ•´åˆåˆ°ç¾æœ‰çš„ Fastify æ¶æ§‹
- æ”¯æ´èªè­‰å’Œæ¬Šé™ç³»çµ±
- ç”Ÿæˆ TypeScript å®¢æˆ¶ç«¯ç¨‹å¼ç¢¼

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… åŸºç¤ API æ¶æ§‹å·²å®Œæˆ
- âœ… èªè­‰ç³»çµ±å·²å¯¦ç¾ (TASK 7-9)
- âœ… æ‰€æœ‰ API ç«¯é»å·²å®šç¾©

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ”§ ä¾è³´å¥—ä»¶
```bash
npm install @fastify/swagger @fastify/swagger-ui
npm install --save-dev swagger-jsdoc @types/swagger-jsdoc
```

### ğŸ“ æª”æ¡ˆçµæ§‹

```
apps/server/src/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ schemas/           # OpenAPI Schema å®šç¾©
â”‚   â”‚   â”œâ”€â”€ common.ts      # é€šç”¨ Schema
â”‚   â”‚   â”œâ”€â”€ auth.ts        # èªè­‰ç›¸é—œ Schema
â”‚   â”‚   â”œâ”€â”€ todos.ts       # Todos Schema
â”‚   â”‚   â””â”€â”€ users.ts       # ç”¨æˆ¶ Schema
â”‚   â”œâ”€â”€ config.ts          # Swagger é…ç½®
â”‚   â””â”€â”€ generator.ts       # æ–‡æª”ç”Ÿæˆå™¨
â”œâ”€â”€ openapi/
â”‚   â”œâ”€â”€ openapi.json       # ç”Ÿæˆçš„ OpenAPI è¦æ ¼
â”‚   â””â”€â”€ client/            # ç”Ÿæˆçš„å®¢æˆ¶ç«¯ç¨‹å¼ç¢¼
â””â”€â”€ test/
    â””â”€â”€ docs/
        â””â”€â”€ openapi.test.ts
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: Swagger åŸºç¤é…ç½®

```typescript
// apps/server/src/docs/config.ts
export const swaggerConfig = {
  openapi: {
    openapi: '3.0.3',
    info: {
      title: 'Fastify API Documentation',
      description: 'A modern TypeScript backend API with Fastify + Drizzle ORM + PostgreSQL',
      version: '1.0.0',
      contact: {
        name: 'API Support',
        email: 'support@fastify-api.com'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'http://localhost:8080',
        description: 'Development server'
      },
      {
        url: 'https://api.yourapp.com',
        description: 'Production server'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'JWT Authorization header using the Bearer scheme'
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  swaggerUiOptions: {
    routePrefix: '/docs',
    exposeRoute: true,
    staticCSP: true,
    transformStaticCSP: (header: string) => header,
    uiConfig: {
      docExpansion: 'list',
      deepLinking: false,
      defaultModelsExpandDepth: 2,
      defaultModelExpandDepth: 2
    }
  }
};
```

### Step 2: Schema å®šç¾©

```typescript
// apps/server/src/docs/schemas/common.ts
export const commonSchemas = {
  Error: {
    type: 'object',
    required: ['success', 'error'],
    properties: {
      success: { type: 'boolean', example: false },
      error: { type: 'string', example: 'Error message' },
      details: {
        type: 'array',
        items: {
          type: 'object',
          properties: {
            field: { type: 'string' },
            message: { type: 'string' }
          }
        }
      }
    }
  },
  
  SuccessResponse: {
    type: 'object',
    required: ['success', 'data'],
    properties: {
      success: { type: 'boolean', example: true },
      data: { type: 'object' }
    }
  },
  
  Pagination: {
    type: 'object',
    properties: {
      page: { type: 'integer', example: 1 },
      limit: { type: 'integer', example: 10 },
      total: { type: 'integer', example: 100 },
      totalPages: { type: 'integer', example: 10 },
      hasNext: { type: 'boolean', example: true },
      hasPrev: { type: 'boolean', example: false }
    }
  }
};
```

```typescript
// apps/server/src/docs/schemas/todos.ts
export const todoSchemas = {
  Todo: {
    type: 'object',
    required: ['id', 'content', 'author', 'createdAt', 'updatedAt', 'isActive'],
    properties: {
      id: { 
        type: 'string', 
        format: 'uuid',
        example: '550e8400-e29b-41d4-a716-446655440000'
      },
      content: { 
        type: 'string', 
        example: 'Complete the API documentation'
      },
      author: { 
        type: 'string', 
        example: 'john_doe'
      },
      createdAt: { 
        type: 'string', 
        format: 'date-time',
        example: '2024-01-15T10:30:00.000Z'
      },
      updatedAt: { 
        type: 'string', 
        format: 'date-time',
        example: '2024-01-15T10:30:00.000Z'
      },
      isActive: { 
        type: 'boolean', 
        example: true
      }
    }
  },
  
  CreateTodoRequest: {
    type: 'object',
    required: ['content', 'author'],
    properties: {
      content: {
        type: 'string',
        minLength: 1,
        example: 'Complete the API documentation'
      },
      author: {
        type: 'string',
        minLength: 1,
        example: 'john_doe'
      }
    }
  },
  
  UpdateTodoRequest: {
    type: 'object',
    properties: {
      content: {
        type: 'string',
        minLength: 1,
        example: 'Updated content'
      },
      author: {
        type: 'string',
        minLength: 1,
        example: 'jane_doe'
      },
      isActive: {
        type: 'boolean',
        example: false
      }
    }
  },
  
  TodosResponse: {
    allOf: [
      { $ref: '#/components/schemas/SuccessResponse' },
      {
        type: 'object',
        properties: {
          data: {
            type: 'object',
            properties: {
              todos: {
                type: 'array',
                items: { $ref: '#/components/schemas/Todo' }
              },
              pagination: { $ref: '#/components/schemas/Pagination' },
              filters: {
                type: 'object',
                properties: {
                  author: { type: 'string' },
                  isActive: { type: 'boolean' },
                  search: { type: 'string' }
                }
              }
            }
          }
        }
      }
    ]
  }
};
```

### Step 3: è·¯ç”±æ–‡æª”è¨»è§£

```typescript
// apps/server/src/todos/routes.ts (æ›´æ–°)
export async function todoRoutes(fastify: FastifyInstance) {
  // GET /api/v1/todos
  fastify.get('/api/v1/todos', {
    schema: {
      description: 'Get all todos with pagination and filtering',
      tags: ['Todos'],
      security: [{ bearerAuth: [] }],
      querystring: {
        type: 'object',
        properties: {
          page: { 
            type: 'integer', 
            minimum: 1, 
            default: 1,
            description: 'Page number'
          },
          limit: { 
            type: 'integer', 
            minimum: 1, 
            maximum: 100, 
            default: 10,
            description: 'Items per page'
          },
          author: { 
            type: 'string',
            description: 'Filter by author'
          },
          isActive: { 
            type: 'boolean',
            description: 'Filter by active status'
          },
          search: { 
            type: 'string',
            description: 'Search in todo content'
          }
        }
      },
      response: {
        200: { $ref: '#/components/schemas/TodosResponse' },
        400: { $ref: '#/components/schemas/Error' },
        401: { $ref: '#/components/schemas/Error' },
        500: { $ref: '#/components/schemas/Error' }
      }
    },
    preHandler: [jwtAuthMiddleware],
    handler: todoController.getAllTodos
  });
  
  // POST /api/v1/todos
  fastify.post('/api/v1/todos', {
    schema: {
      description: 'Create a new todo',
      tags: ['Todos'],
      security: [{ bearerAuth: [] }],
      body: { $ref: '#/components/schemas/CreateTodoRequest' },
      response: {
        201: {
          allOf: [
            { $ref: '#/components/schemas/SuccessResponse' },
            {
              type: 'object',
              properties: {
                data: { $ref: '#/components/schemas/Todo' }
              }
            }
          ]
        },
        400: { $ref: '#/components/schemas/Error' },
        401: { $ref: '#/components/schemas/Error' },
        500: { $ref: '#/components/schemas/Error' }
      }
    },
    preHandler: [jwtAuthMiddleware],
    handler: todoController.createTodo
  });
}
```

### Step 4: èªè­‰ç›¸é—œæ–‡æª”

```typescript
// apps/server/src/docs/schemas/auth.ts
export const authSchemas = {
  LoginRequest: {
    type: 'object',
    required: ['email', 'password'],
    properties: {
      email: {
        type: 'string',
        format: 'email',
        example: 'user@example.com'
      },
      password: {
        type: 'string',
        minLength: 6,
        example: 'password123'
      }
    }
  },
  
  LoginResponse: {
    allOf: [
      { $ref: '#/components/schemas/SuccessResponse' },
      {
        type: 'object',
        properties: {
          data: {
            type: 'object',
            properties: {
              user: { $ref: '#/components/schemas/User' },
              accessToken: { 
                type: 'string',
                example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
              },
              refreshToken: { 
                type: 'string',
                example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
              }
            }
          }
        }
      }
    ]
  }
};
```

### Step 5: ä¼ºæœå™¨æ•´åˆ

```typescript
// apps/server/src/server.ts (æ›´æ–°)
import { swaggerConfig } from './docs/config';
import { registerSwagger } from './docs/generator';

const fastify = Fastify({
  logger: config.server.env === 'development',
});

// è¨»å†Š Swagger
await registerSwagger(fastify);

// è¨»å†Šå…¶ä»–æ’ä»¶å’Œè·¯ç”±...
```

```typescript
// apps/server/src/docs/generator.ts
import { FastifyInstance } from 'fastify';
import { swaggerConfig } from './config';
import { commonSchemas } from './schemas/common';
import { todoSchemas } from './schemas/todos';
import { authSchemas } from './schemas/auth';

export const registerSwagger = async (fastify: FastifyInstance) => {
  // è¨»å†Š Swagger æ’ä»¶
  await fastify.register(require('@fastify/swagger'), {
    ...swaggerConfig.openapi,
    components: {
      ...swaggerConfig.openapi.components,
      schemas: {
        ...commonSchemas,
        ...todoSchemas,
        ...authSchemas
      }
    }
  });

  // è¨»å†Š Swagger UI
  await fastify.register(require('@fastify/swagger-ui'), 
    swaggerConfig.swaggerUiOptions
  );
  
  // åœ¨é–‹ç™¼ç’°å¢ƒä¸­è‡ªå‹•ç”Ÿæˆ OpenAPI æª”æ¡ˆ
  if (process.env.NODE_ENV === 'development') {
    fastify.ready(() => {
      fastify.swagger();
    });
  }
};
```

### Step 6: å®¢æˆ¶ç«¯ç¨‹å¼ç¢¼ç”Ÿæˆ

```typescript
// apps/server/src/docs/generator.ts (æ“´å±•)
export const generateOpenAPISpec = async (fastify: FastifyInstance) => {
  const spec = fastify.swagger();
  
  // å„²å­˜ OpenAPI è¦æ ¼
  const fs = require('fs');
  const path = require('path');
  
  const outputPath = path.join(__dirname, '../openapi/openapi.json');
  fs.writeFileSync(outputPath, JSON.stringify(spec, null, 2));
  
  console.log('OpenAPI specification generated at:', outputPath);
  return spec;
};

// ç”Ÿæˆ TypeScript å®¢æˆ¶ç«¯
export const generateTypeScriptClient = async () => {
  const { execSync } = require('child_process');
  
  try {
    // ä½¿ç”¨ openapi-generator-cli ç”Ÿæˆå®¢æˆ¶ç«¯
    execSync(`
      npx @openapitools/openapi-generator-cli generate \
        -i src/openapi/openapi.json \
        -g typescript-fetch \
        -o src/openapi/client \
        --additional-properties=typescriptThreePlus=true
    `);
    
    console.log('TypeScript client generated successfully');
  } catch (error) {
    console.error('Failed to generate TypeScript client:', error);
  }
};
```

---

## ğŸ“‹ API æ–‡æª”åŠŸèƒ½

### ğŸŒ Swagger UI åŠŸèƒ½
- **äº’å‹•å¼ API æ¸¬è©¦**: ç›´æ¥åœ¨ç€è¦½å™¨ä¸­æ¸¬è©¦ API
- **èªè­‰æ•´åˆ**: æ”¯æ´ JWT Bearer token èªè­‰
- **å³æ™‚å›æ‡‰**: æŸ¥çœ‹ API å›æ‡‰å’ŒéŒ¯èª¤è¨Šæ¯
- **Schema é©—è­‰**: è‡ªå‹•é©—è­‰è«‹æ±‚å’Œå›æ‡‰æ ¼å¼

### ğŸ“Š æ–‡æª”å…§å®¹
- **API ç«¯é»**: å®Œæ•´çš„ç«¯é»åˆ—è¡¨å’Œèªªæ˜
- **è«‹æ±‚/å›æ‡‰ Schema**: è©³ç´°çš„è³‡æ–™æ ¼å¼å®šç¾©
- **éŒ¯èª¤ç¢¼èªªæ˜**: å„ç¨®éŒ¯èª¤æƒ…æ³çš„èªªæ˜
- **ç¯„ä¾‹è³‡æ–™**: å¯¦éš›çš„è«‹æ±‚å’Œå›æ‡‰ç¯„ä¾‹

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### Documentation Tests
```typescript
// apps/server/src/test/docs/openapi.test.ts
describe('OpenAPI Documentation', () => {
  it('should generate valid OpenAPI specification', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // é©—è­‰ OpenAPI è¦æ ¼æ ¼å¼
    expect(spec.openapi).toBe('3.0.3');
    expect(spec.info).toBeDefined();
    expect(spec.paths).toBeDefined();
    expect(spec.components.schemas).toBeDefined();
  });
  
  it('should include all API endpoints', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // æª¢æŸ¥æ‰€æœ‰é‡è¦ç«¯é»æ˜¯å¦åŒ…å«åœ¨æ–‡æª”ä¸­
    expect(spec.paths['/api/v1/todos']).toBeDefined();
    expect(spec.paths['/auth/login']).toBeDefined();
  });
  
  it('should have valid schema definitions', async () => {
    const spec = await generateOpenAPISpec(app);
    
    // æª¢æŸ¥ Schema å®šç¾©
    expect(spec.components.schemas.Todo).toBeDefined();
    expect(spec.components.schemas.User).toBeDefined();
  });
});
```

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½éœ€æ±‚
- [ ] Swagger UI æ­£å¸¸é‹ä½œ
- [ ] æ‰€æœ‰ API ç«¯é»å·²è¨˜éŒ„
- [ ] èªè­‰åŠŸèƒ½æ­£å¸¸æ•´åˆ
- [ ] Schema é©—è­‰æ­£ç¢º
- [ ] ç¯„ä¾‹è³‡æ–™æº–ç¢º

### å“è³ªéœ€æ±‚
- [ ] æ–‡æª”å…§å®¹å®Œæ•´
- [ ] ç¯„ä¾‹è³‡æ–™å¯¦ç”¨
- [ ] éŒ¯èª¤èªªæ˜æ¸…æ¥š
- [ ] äº’å‹•æ¸¬è©¦åŠŸèƒ½æ­£å¸¸

---

## ğŸš€ éƒ¨ç½²é…ç½®

### ç’°å¢ƒè®Šæ•¸
```bash
# .env
SWAGGER_ENABLED=true
SWAGGER_HOST=localhost:8080
API_BASE_URL=https://api.yourapp.com
```

### ç”Ÿç”¢ç’°å¢ƒè€ƒé‡
```typescript
// ç”Ÿç”¢ç’°å¢ƒå¯èƒ½éœ€è¦é™åˆ¶æ–‡æª”å­˜å–
if (process.env.NODE_ENV === 'production') {
  // å¯èƒ½éœ€è¦èªè­‰æ‰èƒ½å­˜å–æ–‡æª”
  swaggerUiOptions.routePrefix = '/internal/docs';
}
```

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

- æ–‡æª”è¼‰å…¥æ™‚é–“: < 2s
- API æ¸¬è©¦å›æ‡‰æ™‚é–“: < 500ms
- æ–‡æª”æ›´æ–°é »ç‡: æ¯æ¬¡éƒ¨ç½²è‡ªå‹•æ›´æ–°
- å®¢æˆ¶ç«¯ç”¢ç”Ÿæ™‚é–“: < 30s