# TASK 1: Drizzle ORM å®‰è£èˆ‡é…ç½®

## ğŸ“‹ ä»»å‹™æ¦‚è¿°

å®‰è£å’Œé…ç½® Drizzle ORMï¼Œå»ºç«‹èˆ‡ PostgreSQL è³‡æ–™åº«çš„é€£æ¥ï¼Œç‚ºå°ˆæ¡ˆå¥ å®šè³‡æ–™å­˜å–åŸºç¤ã€‚

### ğŸ¯ ç›®æ¨™
- å®‰è£ Drizzle ORM å’Œç›¸é—œä¾è³´
- å»ºç«‹è³‡æ–™åº«é€£æ¥é…ç½®
- è¨­ç½®ç’°å¢ƒè®Šæ•¸ç®¡ç†
- å»ºç«‹åŸºç¤çš„å°ˆæ¡ˆçµæ§‹

### ğŸ“Š å‰ç½®æ¢ä»¶
- âœ… Node.js 18+ ç’°å¢ƒ
- âœ… PostgreSQL è³‡æ–™åº«æœå‹™
- âœ… åŸºç¤å°ˆæ¡ˆçµæ§‹

---

## ğŸ—ï¸ æŠ€è¡“è¦æ ¼

### ğŸ”§ ä¾è³´å¥—ä»¶å®‰è£
```bash
# æ ¸å¿ƒ ORM å¥—ä»¶
npm install drizzle-orm

# PostgreSQL å®¢æˆ¶ç«¯
npm install postgres

# é–‹ç™¼å·¥å…·
npm install --save-dev drizzle-kit @types/pg

# ç’°å¢ƒè®Šæ•¸ç®¡ç†
npm install dotenv
```

### ğŸ—„ï¸ è³‡æ–™åº«é…ç½®
- **è³‡æ–™åº«åç¨±**: `fastify-development`
- **ç”¨æˆ¶å**: `postgres`
- **å¯†ç¢¼**: `temp1234`
- **ä¸»æ©Ÿ**: `localhost`
- **ç«¯å£**: `5432`

---

## ğŸ“ æª”æ¡ˆçµæ§‹

### å»ºç«‹çš„æª”æ¡ˆ
```
fastify-api/
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ db/                 # è³‡æ–™åº«å¥—ä»¶
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ index.ts    # è³‡æ–™åº«é€£æ¥å’Œå°å‡º
â”‚       â”‚   â””â”€â”€ schema.ts   # è³‡æ–™åº« Schema å®šç¾©
â”‚       â”œâ”€â”€ package.json    # å¥—ä»¶é…ç½®
â”‚       â””â”€â”€ drizzle.config.ts # Drizzle é…ç½®
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ server/
â”‚       â”œâ”€â”€ .env            # ç’°å¢ƒè®Šæ•¸
â”‚       â””â”€â”€ .env.example    # ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
â””â”€â”€ package.json            # æ ¹ package.json
```

---

## ğŸ”¨ å¯¦æ–½æ­¥é©Ÿ

### Step 1: å°ˆæ¡ˆçµæ§‹å»ºç«‹
```bash
# å»ºç«‹ Monorepo çµæ§‹
mkdir -p packages/db/src
mkdir -p apps/server
```

### Step 2: æ ¹ç›®éŒ„ Package.json é…ç½®
```json
{
  "name": "fastify-api",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "db:push": "turbo run db:push",
    "db:studio": "turbo run db:studio"
  },
  "devDependencies": {
    "turbo": "^1.10.0"
  }
}
```

### Step 3: è³‡æ–™åº«å¥—ä»¶é…ç½®
```json
// packages/db/package.json
{
  "name": "@fastify-api/db",
  "version": "1.0.0",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "db:push": "drizzle-kit push:pg",
    "db:studio": "drizzle-kit studio"
  },
  "dependencies": {
    "drizzle-orm": "^0.44.2",
    "postgres": "^3.4.7"
  },
  "devDependencies": {
    "@types/pg": "^8.10.0",
    "drizzle-kit": "^0.28.0"
  }
}
```

### Step 4: è³‡æ–™åº«é€£æ¥è¨­ç½®
```typescript
// packages/db/src/index.ts
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

const connectionString = process.env.DATABASE_URL || 
  'postgresql://postgres:temp1234@localhost:5432/fastify-development';

const client = postgres(connectionString);
export const db = drizzle(client, { schema });

export * from './schema';
export { eq, and, or, like, sql, count, desc, asc } from 'drizzle-orm';
```

### Step 5: Drizzle Kit é…ç½®
```typescript
// packages/db/drizzle.config.ts
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/schema.ts',
  out: './migrations',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.DATABASE_URL || 
      'postgresql://postgres:temp1234@localhost:5432/fastify-development',
  },
} satisfies Config;
```

### Step 6: ç’°å¢ƒè®Šæ•¸é…ç½®
```bash
# apps/server/.env
DATABASE_URL=postgresql://postgres:temp1234@localhost:5432/fastify-development

# Server Configuration
PORT=8080
HOST=0.0.0.0
NODE_ENV=development
```

```bash
# apps/server/.env.example
DATABASE_URL=postgresql://postgres:temp1234@localhost:5432/fastify-development

PORT=3010
ENV=development
```

---

## ğŸ—„ï¸ åˆå§‹ Schema è¨­è¨ˆ

```typescript
// packages/db/src/schema.ts
import { pgTable, uuid, text, timestamp, boolean } from 'drizzle-orm/pg-core';

export const todos = pgTable('todos', {
  id: uuid('id').primaryKey().defaultRandom(),
  content: text('content').notNull(),
  author: text('author').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  isActive: boolean('is_active').default(true).notNull(),
});

export type Todo = typeof todos.$inferSelect;
export type NewTodo = typeof todos.$inferInsert;
```

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### è³‡æ–™åº«é€£æ¥æ¸¬è©¦
```typescript
// æ¸¬è©¦è³‡æ–™åº«é€£æ¥
import { db } from '@fastify-api/db';

async function testConnection() {
  try {
    await db.select().from(todos).limit(1);
    console.log('âœ… Database connection successful');
  } catch (error) {
    console.error('âŒ Database connection failed:', error);
  }
}
```

### åŸºæœ¬ CRUD æ“ä½œæ¸¬è©¦
```typescript
// æ¸¬è©¦åŸºæœ¬æ“ä½œ
async function testBasicOperations() {
  // å‰µå»ºæ¸¬è©¦è³‡æ–™
  const newTodo = await db.insert(todos).values({
    content: 'Test todo',
    author: 'System'
  }).returning();
  
  console.log('Created todo:', newTodo[0]);
  
  // æŸ¥è©¢è³‡æ–™
  const allTodos = await db.select().from(todos);
  console.log('All todos:', allTodos);
}
```

---

## âœ… å®Œæˆæ¨™æº–

### æŠ€è¡“é©—æ”¶
- [x] Drizzle ORM æˆåŠŸå®‰è£
- [x] PostgreSQL é€£æ¥æ­£å¸¸å»ºç«‹
- [x] ç’°å¢ƒè®Šæ•¸é…ç½®å®Œæˆ
- [x] åŸºç¤ Schema å®šç¾©å®Œæˆ
- [x] Monorepo çµæ§‹å»ºç«‹

### åŠŸèƒ½é©—æ”¶
- [x] è³‡æ–™åº«é€£æ¥æ¸¬è©¦é€šé
- [x] åŸºæœ¬æŸ¥è©¢æ“ä½œæ­£å¸¸
- [x] ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¼‰å…¥
- [x] TypeScript å‹åˆ¥æ¨æ–·æ­£å¸¸

---

## ğŸ” å•é¡Œæ’è§£

### å¸¸è¦‹å•é¡Œ
1. **é€£æ¥å¤±æ•—**: æª¢æŸ¥ PostgreSQL æœå‹™æ˜¯å¦å•Ÿå‹•
2. **æ¬Šé™éŒ¯èª¤**: ç¢ºèªè³‡æ–™åº«ç”¨æˆ¶æ¬Šé™
3. **å‹åˆ¥éŒ¯èª¤**: æª¢æŸ¥ Drizzle ORM ç‰ˆæœ¬ä¸€è‡´æ€§

### èª¿è©¦å‘½ä»¤
```bash
# æª¢æŸ¥è³‡æ–™åº«é€£æ¥
psql -h localhost -U postgres -d fastify-development

# æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
echo $DATABASE_URL

# æª¢æŸ¥ Drizzle Kit
npx drizzle-kit studio
```

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

### å»ºç«‹çš„åŸºæº–
- è³‡æ–™åº«é€£æ¥æ™‚é–“: < 100ms
- åŸºæœ¬æŸ¥è©¢å›æ‡‰: < 50ms
- å‹åˆ¥æª¢æŸ¥: ç„¡éŒ¯èª¤
- å¥—ä»¶å¤§å°: æœ€å°åŒ–

### ç›£æ§é‡é»
- é€£æ¥æ± ç‹€æ…‹
- æŸ¥è©¢æ•ˆèƒ½
- è¨˜æ†¶é«”ä½¿ç”¨
- éŒ¯èª¤ç‡

---

## ğŸš€ å¾ŒçºŒæ­¥é©Ÿ

### ç«‹å³å¾ŒçºŒä»»å‹™
1. **TASK 2**: æ“´å±•è³‡æ–™åº« Schema
2. **TASK 3**: å¯¦ç¾ CRUD æ“ä½œ
3. å»ºç«‹è³‡æ–™åº«é·ç§»æ©Ÿåˆ¶

### é•·æœŸå„ªåŒ–
- é€£æ¥æ± æœ€ä½³åŒ–
- æŸ¥è©¢æ•ˆèƒ½èª¿å„ª
- ç›£æ§å’Œæ—¥èªŒæ•´åˆ